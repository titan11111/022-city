<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#87CEEB">
    <title>ç”ºé•·ã‚·ãƒ DX: Evolution Edition</title>
    <style>
        :root {
            /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
            --c-eco: #f39c12; 
            --c-env: #27ae60; 
            --c-edu: #8e44ad;
            --c-text: #1a202c; 
            --c-bg-glass: rgba(255, 255, 255, 0.92);
            --shadow-soft: 0 8px 30px rgba(0, 0, 0, 0.08);
            --radius-M: 16px;
            
            /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
            --header-h: 64px;
            --sidebar-w: 100px;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none;
        }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            color: var(--c-text);
            height: 100dvh; 
            overflow: hidden;
            transition: background 1.5s ease;
        }

        #app {
            width: 100%; height: 100%; max-width: 1000px; margin: 0 auto;
            display: flex; flex-direction: column;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            position: relative;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            height: calc(var(--header-h) + var(--safe-top));
            padding: var(--safe-top) 20px 0;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255, 255, 255, 0.85);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            z-index: 20; flex-shrink: 0;
        }

        h1 { 
            margin: 0; font-size: 18px; font-weight: 800; 
            background: linear-gradient(90deg, #2c3e50, #3498db);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .turn-badge { 
            font-size: 13px; background: #fff; padding: 6px 14px; 
            border-radius: 20px; font-weight: 700; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); color: #444;
            display: flex; align-items: center; gap: 6px;
        }

        /* ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¸ */
        #game-stage {
            flex: 1; display: flex; overflow: hidden; position: relative;
            padding-bottom: var(--safe-bottom);
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        #sidebar {
            width: var(--sidebar-w); background: rgba(255,255,255,0.6);
            padding: 16px 12px; display: flex; flex-direction: column; gap: 20px;
            border-right: 1px solid rgba(255,255,255,0.4);
            overflow-y: auto; flex-shrink: 0;
        }

        main {
            flex: 1; padding: 16px; display: flex; flex-direction: column; gap: 16px;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            #game-stage { flex-direction: column; }
            #sidebar {
                width: 100%; height: auto; flex-direction: row; justify-content: space-evenly;
                padding: 10px 16px; background: rgba(255,255,255,0.9);
                border-right: none; border-bottom: 1px solid rgba(0,0,0,0.05);
                flex-shrink: 0; min-height: 60px;
            }
            .stat-item { flex: 1; max-width: 30%; }
            #town-view { aspect-ratio: auto; height: 200px; }
        }

        .stat-item { display: flex; flex-direction: column; gap: 6px; }
        .stat-header { display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; color: #555; }
        .progress-track { height: 10px; background: rgba(0,0,0,0.06); border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); border-radius: 6px; }
        
        .fill-eco { background: linear-gradient(90deg, #f1c40f, #e67e22); } 
        .fill-env { background: linear-gradient(90deg, #2ecc71, #27ae60); } 
        .fill-edu { background: linear-gradient(90deg, #9b59b6, #8e44ad); }
        .val-danger { color: #e74c3c; animation: beat 0.5s infinite alternate; }

        /* ã‚¿ã‚¦ãƒ³ãƒ“ãƒ¥ãƒ¼ (SVG) */
        #town-view {
            width: 100%; aspect-ratio: 2.8 / 1;
            background: #87CEEB; border-radius: var(--radius-M);
            overflow: hidden; box-shadow: var(--shadow-soft);
            border: 1px solid rgba(255,255,255,0.6);
            flex-shrink: 0; position: relative; transition: background 2s ease;
        }
        #townSvg { width: 100%; height: 100%; display: block; object-fit: cover; }
        .window-rect { transition: fill-opacity 2s ease, fill 2s ease; }

        /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³BOX (ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¨ãƒªã‚¢) */
        #reaction-box {
            background: var(--c-bg-glass); padding: 12px 16px; 
            border-radius: var(--radius-M); box-shadow: var(--shadow-soft);
            display: flex; align-items: center; gap: 14px; min-height: 80px; flex-shrink: 0;
            border-left: 5px solid #aaa; transition: border-color 0.4s;
            position: relative;
        }
        .char-avatar { 
            width: 60px; height: 60px; 
            background: #f0f2f5 url('images/character.png') no-repeat center top / cover; 
            border-radius: 50%; flex-shrink: 0; border: 2px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .reaction-content { flex: 1; }
        .reaction-msg { font-size: 13px; line-height: 1.5; font-weight: 600; color: #333; }
        
        /* ã‚¯ã‚¨ã‚¹ãƒˆè¡¨ç¤º */
        #quest-badge {
            display: inline-block; font-size: 10px; background: #e74c3c; color: white;
            padding: 2px 6px; border-radius: 4px; margin-bottom: 4px; font-weight: bold;
            animation: pulse 2s infinite; display: none;
        }
        #quest-badge.active { display: inline-block; }

        /* é¸æŠè‚¢ã‚¨ãƒªã‚¢ */
        #choices-container {
            display: grid; gap: 12px; padding-bottom: calc(60px + var(--safe-bottom)); 
        }
        .choice-card {
            background: var(--c-bg-glass); border: 1px solid rgba(255,255,255,0.4);
            border-radius: var(--radius-M); padding: 14px 18px;
            text-align: left; box-shadow: var(--shadow-soft);
            position: relative; overflow: hidden; cursor: pointer; width: 100%;
            display: flex; flex-direction: column; gap: 4px;
            transition: transform 0.1s, background 0.2s;
        }
        .choice-card:active { transform: scale(0.97); background: #fff; }
        .choice-card::before { content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; }
        
        .type-eco::before { background: var(--c-eco); }
        .type-env::before { background: var(--c-env); }
        .type-edu::before { background: var(--c-edu); }
        .type-bal::before { background: #34495e; }
        .type-event::before { background: #e74c3c; } /* ã‚¤ãƒ™ãƒ³ãƒˆç”¨ */

        .choice-title { font-size: 15px; font-weight: 700; color: #2d3748; display: flex; align-items: center; }
        .choice-desc { font-size: 12px; color: #718096; margin-top: 2px; }
        .combo-badge { 
            background: linear-gradient(135deg, #f1c40f, #f39c12); color: white; 
            font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-right: 8px; 
            font-weight: 800; animation: pulse 2s infinite;
        }

        /* ã‚¤ãƒ™ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« */
        .event-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            background: rgba(255,255,255,0.95); padding: 24px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); z-index: 200; width: 85%; max-width: 320px;
            text-align: center; opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .event-modal.active { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
        .event-icon { font-size: 40px; margin-bottom: 10px; }
        .event-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #c0392b; }
        .event-desc { font-size: 13px; color: #555; line-height: 1.6; margin-bottom: 20px; }

        /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .screen-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240, 242, 245, 0.9); backdrop-filter: blur(10px);
            z-index: 100; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: #333;
            padding: 40px 20px; text-align: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .screen-overlay.active { opacity: 1; pointer-events: auto; }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 16px 40px; border-radius: 50px;
            font-size: 16px; font-weight: 700; letter-spacing: 0.05em;
            box-shadow: 0 10px 30px rgba(118, 75, 162, 0.3); cursor: pointer; margin-top: 30px;
        }

        /* çµæœç”»é¢æ‹¡å¼µ */
        .rank-badge { 
            font-size: 20px; font-weight: 900; background: #2c3e50; color: #fff; 
            padding: 5px 20px; border-radius: 8px; display: inline-block; margin-bottom: 10px;
        }
        .title-reward {
            margin-top: 10px; font-size: 16px; font-weight: bold; color: #d35400;
            background: #fff3e0; padding: 8px 16px; border-radius: 8px;
            border: 1px solid #ffe0b2;
        }

        #bgm-toggle {
            position: absolute; bottom: calc(20px + var(--safe-bottom)); right: 20px;
            width: 48px; height: 48px; border-radius: 50%;
            background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border: none; font-size: 22px; z-index: 90; cursor: pointer;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes drive { from { transform: translateX(-150px); } to { transform: translateX(850px); } }
        @keyframes fly { from { transform: translateX(900px); } to { transform: translateX(-200px); } }
        @keyframes twinkle { 0%,100% { opacity: 0.3; } 50% { opacity: 1; } }
        .hidden { opacity: 0; pointer-events: none; transition: opacity 0.8s; } 
        .visible { opacity: 1; transition: opacity 0.8s; }
        .emergency-mode header { border-bottom: 3px solid #e74c3c; animation: flash 1s infinite; }
        @keyframes flash { 50% { border-color: transparent; } }
    </style>
</head>
<body>

    <div id="app">
        <header>
            <h1>ğŸŒ† ç”ºé•·ã‚·ãƒ DX <span style="font-size:0.6em; opacity:0.6; font-weight:normal;">EVO</span></h1>
            <div class="turn-badge">
                <span id="time-icon">â˜€ï¸</span>
                <span>TURN <span id="turn-num">1</span>/<span id="max-turn">30</span></span>
            </div>
        </header>

        <div id="game-stage">
            <aside id="sidebar">
                <div class="stat-item">
                    <div class="stat-header"><span>ğŸ’°çµŒæ¸ˆ</span><span id="val-eco">20</span></div>
                    <div class="progress-track"><div class="progress-fill fill-eco" id="bar-eco"></div></div>
                </div>
                <div class="stat-item">
                    <div class="stat-header"><span>ğŸŒ¿ç’°å¢ƒ</span><span id="val-env">20</span></div>
                    <div class="progress-track"><div class="progress-fill fill-env" id="bar-env"></div></div>
                </div>
                <div class="stat-item">
                    <div class="stat-header"><span>ğŸ“šæ•™è‚²</span><span id="val-edu">20</span></div>
                    <div class="progress-track"><div class="progress-fill fill-edu" id="bar-edu"></div></div>
                </div>
            </aside>

            <main>
                <div id="town-view">
                    <svg id="townSvg" viewBox="0 0 800 320" preserveAspectRatio="xMidYMid slice">
                        <defs>
                            <linearGradient id="skyMorning" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#FF9A9E"/><stop offset="100%" stop-color="#FECFEF"/></linearGradient>
                            <linearGradient id="skyDay" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#87CEEB"/><stop offset="100%" stop-color="#E0F7FA"/></linearGradient>
                            <linearGradient id="skyEvening" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#FF7F50"/><stop offset="100%" stop-color="#4b6cb7"/></linearGradient>
                            <linearGradient id="skyNight" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#0f2027"/><stop offset="100%" stop-color="#2c5364"/></linearGradient>
                            <linearGradient id="grass" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#7CFC00"/><stop offset="100%" stop-color="#32CD32"/></linearGradient>
                            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur in="SourceAlpha" stdDeviation="2"/><feOffset dx="2" dy="2" result="offsetblur"/><feComponentTransfer><feFuncA type="linear" slope="0.3"/></feComponentTransfer><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                            <pattern id="win-pattern" width="10" height="15" patternUnits="userSpaceOnUse"><rect class="window-rect" width="6" height="10" fill="white" fill-opacity="0.6"/></pattern>
                        </defs>
                        
                        <rect id="sky-rect" width="800" height="320" fill="url(#skyDay)" style="transition: fill 2s ease;" />
                        
                        <g id="vis-nature" class="hidden">
                             <path d="M-50,250 Q100,200 250,250 T550,250" fill="#228B22" opacity="0.4"/>
                             <g transform="translate(60, 210)"><circle r="30" fill="#2ecc71" opacity="0.6"/><rect width="10" height="40" x="-5" y="20" fill="#8B4513"/></g>
                             <g transform="translate(740, 210)"><circle r="35" fill="#27ae60" opacity="0.6"/><rect width="12" height="40" x="-6" y="20" fill="#8B4513"/></g>
                        </g>

                        <g id="stars" class="hidden">
                            <circle cx="100" cy="50" r="1.5" fill="white" class="twinkle" style="animation-delay:0s"/>
                            <circle cx="300" cy="80" r="1.5" fill="white" class="twinkle" style="animation-delay:1s"/>
                            <circle cx="700" cy="90" r="1.5" fill="white" class="twinkle" style="animation-delay:2s"/>
                        </g>

                        <circle id="sun" cx="700" cy="50" r="40" fill="#FFD700" opacity="0.8" style="filter:url(#shadow); transition: opacity 2s ease;"/>
                        <circle id="moon" cx="100" cy="50" r="30" fill="#F4F6F0" opacity="0" style="filter:url(#shadow); transition: opacity 2s ease;"/>

                        <rect y="220" width="800" height="100" fill="url(#grass)" />
                        <rect y="250" width="800" height="50" fill="#555" />
                        <line x1="0" y1="275" x2="800" y2="275" stroke="#fff" stroke-width="2" stroke-dasharray="30,30"/>

                        <g id="lvl-1" class="visible">
                            <g transform="translate(100, 200)">
                                <rect x="0" y="20" width="60" height="40" fill="#DEB887" stroke="#8B4513" stroke-width="2"/>
                                <path d="M-10,20 L30,-10 L70,20 Z" fill="#A52A2A" stroke="#5d4037" stroke-width="2"/>
                                <g id="vis-solar" class="hidden" transform="translate(10, -5) skewX(-20)">
                                    <rect width="40" height="15" fill="#2980b9" stroke="#fff" stroke-width="1"/>
                                    <line x1="10" y1="0" x2="10" y2="15" stroke="#fff"/>
                                    <line x1="20" y1="0" x2="20" y2="15" stroke="#fff"/>
                                    <line x1="30" y1="0" x2="30" y2="15" stroke="#fff"/>
                                </g>
                            </g>
                            <g transform="translate(700, 180)"><g class="sway"><rect x="5" y="30" width="10" height="50" fill="#8B4513"/><circle cx="10" cy="20" r="30" fill="#006400"/></g></g>
                        </g>

                        <g id="lvl-2" class="hidden">
                            <g transform="translate(300, 180)">
                                <rect x="0" y="20" width="100" height="60" fill="#fce4ec" stroke="#ec407a" stroke-width="2"/>
                                <rect x="0" y="0" width="100" height="20" fill="#ec407a"/>
                                <text x="50" y="15" text-anchor="middle" fill="white" font-weight="bold" font-size="12">SHOP</text>
                            </g>
                        </g>

                        <g id="lvl-3" class="hidden">
                            <rect x="500" y="100" width="80" height="150" fill="#95a5a6" stroke="#7f8c8d" stroke-width="2"/>
                            <rect x="510" y="110" width="60" height="130" fill="url(#win-pattern)"/>
                            <g id="vis-factory" class="hidden" transform="translate(560, 80)">
                                <rect x="0" y="0" width="15" height="20" fill="#555"/>
                                <circle cx="7" cy="-5" r="5" fill="#777" opacity="0.6" style="animation: float 4s infinite"/>
                                <circle cx="12" cy="-15" r="7" fill="#777" opacity="0.4" style="animation: float 4s infinite 1s"/>
                            </g>
                        </g>

                        <g id="lvl-4" class="hidden">
                            <rect x="350" y="20" width="120" height="230" fill="#8e44ad" opacity="0.9"/>
                            <rect x="360" y="30" width="100" height="210" fill="url(#win-pattern)"/>
                            <g transform="translate(0, 50)"><g class="fly" style="animation-duration: 20s;"><path d="M0,0 L40,-10 L50,0 L40,10 Z" fill="#ecf0f1" stroke="#bdc3c7"/></g></g>
                        </g>

                        <g id="lvl-5" class="hidden">
                            <path d="M650,250 L680,50 L720,50 L750,250 Z" fill="#00bcd4" opacity="0.8"/>
                        </g>
                        
                        <g class="drive" style="animation-duration: 12s; animation-delay: -5s;">
                            <rect x="0" y="245" width="40" height="20" fill="#f1c40f" rx="4"/>
                            <circle cx="10" cy="265" r="5" fill="#333"/>
                            <circle cx="30" cy="265" r="5" fill="#333"/>
                        </g>
                    </svg>
                </div>

                <div id="reaction-box">
                    <div class="char-avatar"></div>
                    <div class="reaction-content">
                        <div id="quest-badge">ğŸ“œ é™³æƒ…ã‚ã‚Šï¼</div>
                        <div class="reaction-msg" id="char-msg">å¸‚é•·ã€å°±ä»»ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<br>30ã‚¿ãƒ¼ãƒ³ã®ä»»æœŸã§æœ€é«˜ã®ç”ºã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚</div>
                    </div>
                </div>

                <div id="choices-container"></div>
            </main>
        </div>

        <button id="bgm-toggle" style="display:none;">ğŸ”Š</button>

        <div id="event-modal" class="event-modal">
            <div class="event-icon">ğŸŒªï¸</div>
            <div class="event-title">ç·Šæ€¥ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼</div>
            <div class="event-desc">è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆ</div>
            <button class="btn-primary" onclick="closeEventModal()" style="margin-top:10px; padding:10px 30px; font-size:14px;">ç¢ºèª</button>
        </div>

        <div id="start-screen" class="screen-overlay active">
            <h1 style="font-size: 2.5em; margin-bottom: 20px;">ğŸŒ† ç”ºé•·ã‚·ãƒ DX <span style="font-size:0.5em; color:#667eea;">EVO</span></h1>
            <p style="margin: 30px 0; line-height: 2;">
                çµŒæ¸ˆãƒ»ç’°å¢ƒãƒ»æ•™è‚²ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚ŠãªãŒã‚‰<br>
                äºˆæ¸¬ä¸èƒ½ãªã‚¤ãƒ™ãƒ³ãƒˆã‚„é™³æƒ…ã«å¯¾å¿œã—ã€<br>
                ã‚ãªãŸã ã‘ã®éƒ½å¸‚ã‚’ç¯‰ãä¸Šã’ã¦ãã ã•ã„ã€‚
            </p>
            <button class="btn-primary" id="start-btn">å°±ä»»ã™ã‚‹</button>
        </div>

        <div id="result-screen" class="screen-overlay">
            <h2 id="res-title" style="margin:0 0 10px 0; color:#2c3e50;">CLEAR!</h2>
            <div class="rank-badge" id="res-rank">RANK A</div>
            <div class="title-reward" id="res-mayor-title">ç§°å·: å¹³å‡¡ãªå¸‚é•·</div>
            
            <div class="score-board" style="display:flex; gap:20px; margin:20px 0; justify-content:center;">
                <div class="score-item"><span class="score-val" style="color:var(--c-eco)" id="res-eco">0</span><br><span style="font-size:10px">çµŒæ¸ˆ</span></div>
                <div class="score-item"><span class="score-val" style="color:var(--c-env)" id="res-env">0</span><br><span style="font-size:10px">ç’°å¢ƒ</span></div>
                <div class="score-item"><span class="score-val" style="color:var(--c-edu)" id="res-edu">0</span><br><span style="font-size:10px">æ•™è‚²</span></div>
            </div>

            <div id="feedback-container"></div>
            <button class="btn-primary" id="restart-btn">æœ€åˆã‹ã‚‰éŠã¶</button>
        </div>
    </div>

    <script>
        // === Game Config ===
        const CONFIG = { maxTurns: 30, dangerLine: 10, maxStat: 250 };
        
        // === Choice Data (with Visual Tags) ===
        const choicePool = [
            { id: 'market', type: 'eco', text: "é’ç©ºå¸‚å ´ã®é–‹å‚¬", eco: 5, env: 1, edu: 1, desc: "åœ°å…ƒã®ç‰¹ç”£å“ã‚’è²©å£²" },
            { id: 'bus', type: 'bal', text: "ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒã‚¹", eco: -2, env: 3, edu: 1, desc: "é«˜é½¢è€…ã®è¶³ã‚’ç¢ºä¿" },
            { id: 'clean', type: 'env', text: "ã‚´ãƒŸæ‹¾ã„æ´»å‹•", eco: 0, env: 5, edu: 1, desc: "è¡—ã‚’ãã‚Œã„ã«ã™ã‚‹" },
            { id: 'repair', type: 'edu', text: "å…¬æ°‘é¤¨ã®ä¿®ç¹•", eco: -2, env: 0, edu: 5, desc: "å­¦ã³ã®å ´ã‚’å®ˆã‚‹" },
            { id: 'factory', type: 'eco', text: "å·¥å ´èª˜è‡´", eco: 12, env: -8, edu: 0, desc: "ç…™çªãŒå¢—ãˆã¾ã™", comboText:"å·¥æ¥­åœ°å¸¯", vis: 'vis-factory' }, // Visual tag
            { id: 'mall', type: 'eco', text: "å¤§å‹ãƒ¢ãƒ¼ãƒ«å»ºè¨­", eco: 15, env: -5, edu: 1, desc: "å•†æ¥­æ´»æ€§åŒ–", comboText:"å•†æ¥­ãƒãƒ–" },
            { id: 'it_park', type: 'eco', text: "ITãƒ‘ãƒ¼ã‚¯å»ºè¨­", eco: 10, env: -2, edu: 3, desc: "ãƒã‚¤ãƒ†ã‚¯é›†ç©", comboText:"ã‚·ãƒªã‚³ãƒ³ãƒãƒ¬ãƒ¼" },
            { id: 'solar', type: 'env', text: "ã‚½ãƒ¼ãƒ©ãƒ¼ç™ºé›»æ‰€", eco: -3, env: 10, edu: 2, desc: "å±‹æ ¹ã«ãƒ‘ãƒãƒ«è¨­ç½®", comboText:"ã‚¨ã‚³ã‚¿ã‚¦ãƒ³", vis: 'vis-solar' }, // Visual tag
            { id: 'park_big', type: 'env', text: "å¤§è¦æ¨¡å…¬åœ’", eco: -5, env: 12, edu: 2, desc: "æ£®ã‚’å¢—ã‚„ã™", comboText:"æ£®æ—éƒ½å¸‚", vis: 'vis-nature' }, // Visual tag
            { id: 'recycle', type: 'env', text: "ãƒªã‚µã‚¤ã‚¯ãƒ«å·¥å ´", eco: 2, env: 9, edu: 3, desc: "è³‡æºå†åˆ©ç”¨", comboText:"å¾ªç’°ç¤¾ä¼š" },
            { id: 'library', type: 'edu', text: "ä¸­å¤®å›³æ›¸é¤¨", eco: -3, env: 1, edu: 10, desc: "çŸ¥ã®æ‹ ç‚¹", comboText:"å­¦è¡“éƒ½å¸‚" },
            { id: 'univ', type: 'edu', text: "å¤§å­¦ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹", eco: 5, env: -2, edu: 15, req: 'library', desc: "é«˜ç­‰æ•™è‚²æ©Ÿé–¢", comboText:"ç ”ç©¶éƒ½å¸‚" },
            { id: 'tablet', type: 'edu', text: "ICTæ•™è‚²å°å…¥", eco: -4, env: 1, edu: 8, desc: "å…¨ç”Ÿå¾’ã«ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ", comboText:"ãƒ‡ã‚¸ã‚¿ãƒ«æ•™è‚²" },
            { id: 'festival', type: 'bal', text: "å¤§èŠ±ç«å¤§ä¼š", eco: 8, env: -2, edu: 1, desc: "è¦³å…‰å®¢èª˜è‡´" },
            { id: 'hospital', type: 'bal', text: "ç·åˆç—…é™¢", eco: -5, env: 2, edu: 4, desc: "å¥åº·ã‚’å®ˆã‚‹" },
            { id: 'smart', type: 'bal', text: "ã‚¹ãƒãƒ¼ãƒˆã‚·ãƒ†ã‚£åŒ–", eco: 10, env: 8, edu: 8, req: 'it_park', desc: "éƒ½å¸‚OSã§æœ€é©åŒ–", comboText:"æœªæ¥éƒ½å¸‚" }
        ];

        // === Event Data ===
        const randomEvents = [
            { name: "å¤§å‹å°é¢¨æ¥è¿‘", icon: "ğŸŒ€", desc: "ç’°å¢ƒã‚¤ãƒ³ãƒ•ãƒ©ãŒè©¦ã•ã‚Œã¾ã™ï¼(ç’°å¢ƒãŒé«˜ã„ã¨è¢«å®³æ¸›)", check: 'env', val: 50, penalty: {eco:-10, edu:-5}, successMsg: "è±Šã‹ãªæ£®ãŒé˜²é¢¨æ—ã¨ãªã‚Šè¢«å®³ã‚’é˜²ãã¾ã—ãŸï¼" },
            { name: "ç‰¹åˆ¥çµ¦ä»˜é‡‘", icon: "ğŸ’¸", desc: "å›½ã‹ã‚‰æ”¯æ´é‡‘ãŒå±Šãã¾ã—ãŸã€‚å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹UPï¼", type: 'bonus', effect: {eco:5, env:5, edu:5} },
            { name: "æ„ŸæŸ“ç—‡ã®æµè¡Œ", icon: "ãƒã‚¹ã‚¯", desc: "ç—…é™¢ãŒå¿…è¦ã§ã™ï¼(æ•™è‚²ãŒé«˜ã„ã¨å¯¾å¿œæ—©)", check: 'edu', val: 60, penalty: {eco:-15}, successMsg: "è³¢æ˜ãªå¸‚æ°‘ã®å¯¾å¿œã§æ—©æœŸåæŸã—ã¾ã—ãŸã€‚" },
            { name: "ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ–ãƒ¼ãƒ ", icon: "âœˆï¸", desc: "è¦³å…‰å®¢ãŒæ®ºåˆ°ï¼çµŒæ¸ˆUPã€ç’°å¢ƒDOWNã€‚", type: 'bonus', effect: {eco:15, env:-5, edu:0} }
        ];

        const characters = {
            eco: { color: "#f39c12", msgs: ["æ ªä¾¡ä¸Šæ˜‡ï¼ç´ æ™´ã‚‰ã—ã„æ‰‹è…•ã§ã™ã€‚", "ç¨åãŒæ½¤æ²¢ã§ã™ã­ã€‚", "ã“ã®èª¿å­ã§çµŒæ¸ˆå¤§å›½ã¸ï¼"] },
            env: { color: "#27ae60", msgs: ["ç©ºæ°—ãŒç¾å‘³ã—ã„ã§ã™ã€‚", "ç·‘è±Šã‹ãªè¡—ã€æœ€é«˜ã§ã™ã€‚", "è‡ªç„¶ã¨ã®å…±ç”Ÿã“ãæœªæ¥ã§ã™ã€‚"] },
            edu: { color: "#8e44ad", msgs: ["ç´ æ™´ã‚‰ã—ã„æ•™è‚²ç’°å¢ƒã§ã™ã€‚", "å­ä¾›ãŸã¡ã®ç›®ãŒè¼ã„ã¦ã„ã¾ã™ã€‚", "çŸ¥æ€§ã“ãè¡—ã®å®ã§ã™ã€‚"] },
            normal: { color: "#666", msgs: ["ä½ã¿ã‚„ã™ã„è¡—ã§ã™ã­ã€‚", "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™å¸‚é•·ã€‚", "ä»Šæ—¥ã‚‚ä¸€æ—¥é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚"] },
            angry: { color: "#c0392b", msgs: ["ç”Ÿæ´»ãŒè‹¦ã—ã„ï¼ãªã‚“ã¨ã‹ã—ã¦ï¼", "ç’°å¢ƒãŒæ‚ªã™ãã‚‹ï¼", "å¸‚é•·ã€çœŸé¢ç›®ã«ã‚„ã£ã¦ï¼"] }
        };

        let state = { eco: 20, env: 20, edu: 20, turn: 0, lastChoice: null, bgmOn: false, isPlaying: false, visuals: new Set(), quest: null };

        // === Audio System (Dynamic) ===
        const AudioSys = {
            ctx: null,
            init: function() {
                if(!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
                if(this.ctx.state === 'suspended') this.ctx.resume();
            },
            playTone: function(freq, type, duration, vol=0.1) {
                if(!this.ctx || this.ctx.state !== 'running') return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            // ç’°å¢ƒéŸ³ç”Ÿæˆï¼ˆé³¥ã®å£°ãªã©ï¼‰
            playAmbience: function(type) {
                if(!state.bgmOn) return;
                if(type === 'nature' && Math.random() > 0.7) {
                    // é³¥ã®ã•ãˆãšã‚Šé¢¨
                    this.playTone(1200 + Math.random()*500, 'sine', 0.1, 0.05);
                } else if(type === 'city' && Math.random() > 0.8) {
                    // éƒ½å¸‚ã®ãƒã‚¤ã‚º
                    this.playTone(100, 'square', 0.2, 0.02);
                }
            },
            playTap: () => AudioSys.playTone(800, 'sine', 0.1, 0.05),
            playCombo: () => { [523, 659, 783, 1046].forEach((f, i) => setTimeout(() => AudioSys.playTone(f, 'triangle', 0.3, 0.1), i * 80)); },
            playEvent: () => AudioSys.playTone(150, 'sawtooth', 0.6, 0.15),
            playStart: () => AudioSys.playTone(1046, 'sine', 0.5, 0.2)
        };

        let bgmAudio = null;
        function initBGM() {
            if (!bgmAudio) {
                bgmAudio = new Audio('town.mp3');
                bgmAudio.loop = true;
                bgmAudio.volume = 0.3;
            }
        }
        function playBGM() {
            if (!bgmAudio) initBGM();
            if (state.bgmOn && state.isPlaying && bgmAudio) {
                // ãƒ”ãƒ³ãƒæ™‚ã«BGMé€Ÿåº¦ã‚’å¤‰ãˆã‚‹æ¼”å‡º
                const isDanger = state.eco < 15 || state.env < 15 || state.edu < 15;
                bgmAudio.playbackRate = isDanger ? 1.1 : 1.0;
                bgmAudio.play().catch(e => console.log('BGM Error', e));
            }
        }
        function stopBGM() { if (bgmAudio) { bgmAudio.pause(); bgmAudio.currentTime = 0; } }
        function toggleBGM() {
            AudioSys.init();
            state.bgmOn = !state.bgmOn;
            document.getElementById('bgm-toggle').textContent = state.bgmOn ? "ğŸ”Š" : "ğŸ”‡";
            if (state.bgmOn && state.isPlaying) playBGM(); else stopBGM();
        }

        // === Game Logic ===

        function startGame() {
            AudioSys.init();
            AudioSys.playStart();
            state = { eco: 20, env: 20, edu: 20, turn: 0, lastChoice: null, bgmOn: true, isPlaying: true, visuals: new Set(), quest: null };
            document.getElementById('start-screen').classList.remove('active');
            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('bgm-toggle').style.display = 'flex';
            document.getElementById('bgm-toggle').textContent = "ğŸ”Š";
            
            // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('[id^="vis-"]').forEach(el => el.classList.remove('visible'));
            document.querySelectorAll('[id^="vis-"]').forEach(el => el.classList.add('hidden'));

            updateUI();
            initBGM();
            playBGM();
            generateQuest(); // åˆå›ã‚¯ã‚¨ã‚¹ãƒˆ
            nextTurn();
        }

        function nextTurn() {
            if(state.turn >= CONFIG.maxTurns) { endGame("clear"); return; }
            state.turn++;
            
            // ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ™ãƒ³ãƒˆåˆ¤å®š (5ã‚¿ãƒ¼ãƒ³ç›®ä»¥é™ã€20%ã®ç¢ºç‡)
            if(state.turn > 3 && Math.random() < 0.2) {
                triggerRandomEvent();
            }

            // ã‚¯ã‚¨ã‚¹ãƒˆæœŸé™ãƒã‚§ãƒƒã‚¯
            checkQuestStatus();

            updateUI();
            renderChoices();
            
            // ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆéŸ³å†ç”Ÿãƒ«ãƒ¼ãƒ—
            if(state.turn % 2 === 0) {
                if(state.env > 80) AudioSys.playAmbience('nature');
                if(state.eco > 80) AudioSys.playAmbience('city');
            }
        }

        function triggerRandomEvent() {
            const evt = randomEvents[Math.floor(Math.random() * randomEvents.length)];
            const modal = document.getElementById('event-modal');
            const title = modal.querySelector('.event-title');
            const desc = modal.querySelector('.event-desc');
            const icon = modal.querySelector('.event-icon');
            
            title.textContent = evt.name;
            icon.textContent = evt.icon;
            
            let resultText = evt.desc;
            let damage = false;

            if (evt.type === 'bonus') {
                state.eco += evt.effect.eco;
                state.env += evt.effect.env;
                state.edu += evt.effect.edu;
            } else {
                // ãƒã‚§ãƒƒã‚¯åˆ¤å®š
                const val = state[evt.check];
                if (val >= evt.val) {
                    resultText += `<br><b style='color:#27ae60'>å›é¿æˆåŠŸï¼(ç¾åœ¨ã®${evt.check}: ${val})</b><br>${evt.successMsg}`;
                } else {
                    damage = true;
                    resultText += `<br><b style='color:#e74c3c'>è¢«å®³ç™ºç”Ÿ... (ãƒœãƒ¼ãƒ€ãƒ¼: ${evt.val})</b>`;
                    if(evt.penalty.eco) state.eco += evt.penalty.eco;
                    if(evt.penalty.env) state.env += evt.penalty.env;
                    if(evt.penalty.edu) state.edu += evt.penalty.edu;
                    AudioSys.playEvent();
                }
            }
            
            desc.innerHTML = resultText;
            modal.classList.add('active');
            updateUI();
        }

        function closeEventModal() {
            document.getElementById('event-modal').classList.remove('active');
        }

        function generateQuest() {
            if (state.turn > 25) return; // çµ‚ç›¤ã¯ã‚¯ã‚¨ã‚¹ãƒˆãªã—
            const types = ['eco', 'env', 'edu'];
            const type = types[Math.floor(Math.random() * 3)];
            const target = state[type] + 30; // ç¾åœ¨+30ã‚’ç›®æŒ‡ã›
            const limit = state.turn + 5;
            
            state.quest = { type: type, target: target, limit: limit, active: true };
            
            // ã‚¯ã‚¨ã‚¹ãƒˆUIè¡¨ç¤º
            const badge = document.getElementById('quest-badge');
            badge.textContent = `ğŸ“œ é™³æƒ…: ${limit}Tã¾ã§ã«${type.toUpperCase()}ã‚’${target}ã¸ï¼`;
            badge.classList.add('active');
        }

        function checkQuestStatus() {
            if(!state.quest || !state.quest.active) return;
            
            const q = state.quest;
            // é”æˆãƒã‚§ãƒƒã‚¯
            if(state[q.type] >= q.target) {
                // æˆåŠŸå ±é…¬
                state.eco += 5; state.env += 5; state.edu += 5;
                showReactionMsg(`ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼é™³æƒ…ãŒèãå…¥ã‚Œã‚‰ã‚Œã¦å¸‚æ°‘ã‚‚å–œã‚“ã§ã„ã¾ã™ï¼ï¼ˆå…¨èƒ½åŠ›+5ï¼‰`, q.type);
                state.quest.active = false;
                document.getElementById('quest-badge').classList.remove('active');
                setTimeout(generateQuest, 3000); // æ¬¡ã®ã‚¯ã‚¨ã‚¹ãƒˆã¸
            } else if (state.turn >= q.limit) {
                // å¤±æ•—
                state.quest.active = false;
                document.getElementById('quest-badge').textContent = "é™³æƒ…å¤±æ•—...";
                setTimeout(() => document.getElementById('quest-badge').classList.remove('active'), 2000);
            }
        }

        function renderChoices() {
            const container = document.getElementById('choices-container');
            container.innerHTML = "";
            let candidates = [...choicePool];
            let selected = [];
            
            // ã‚³ãƒ³ãƒœã®ãƒ­ã‚¸ãƒƒã‚¯
            const comboIdx = candidates.findIndex(c => c.req === state.lastChoice);
            if(comboIdx >= 0) {
                let c = candidates.splice(comboIdx, 1)[0];
                c.isCombo = true;
                selected.push(c);
            }
            while(selected.length < 3 && candidates.length > 0) {
                const idx = Math.floor(Math.random() * candidates.length);
                const c = candidates.splice(idx, 1)[0];
                if(c.req && c.req !== state.lastChoice) continue; 
                selected.push(c);
            }

            selected.forEach(c => {
                const btn = document.createElement('button');
                btn.className = `choice-card type-${c.type}`;
                const comboHtml = c.isCombo ? `<span class="combo-badge">â˜…COMBO</span>` : '';
                btn.innerHTML = `
                    <div class="choice-title">${comboHtml}${c.text}</div>
                    <div class="choice-desc">${c.isCombo ? c.comboText : c.desc}</div>
                `;
                btn.onclick = () => {
                    btn.style.transform = "scale(0.97)";
                    if (navigator.vibrate) navigator.vibrate(5);
                    setTimeout(() => processChoice(c), 150);
                };
                container.appendChild(btn);
            });
        }

        function processChoice(c) {
            AudioSys.init();
            if(c.isCombo) AudioSys.playCombo(); else AudioSys.playTap();
            const bonus = c.isCombo ? 5 : 0;
            state.eco += c.eco + bonus;
            state.env += c.env + bonus;
            state.edu += c.edu + bonus;
            state.lastChoice = c.id;

            // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ°¸ç¶šåŒ–
            if(c.vis) state.visuals.add(c.vis);

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¢—æ¸›ã«åŸºã¥ããƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            if(!state.quest || !state.quest.active) { // ã‚¯ã‚¨ã‚¹ãƒˆé”æˆæ™‚ã¯ãã¡ã‚‰å„ªå…ˆ
                showReaction(c.eco, c.env, c.edu);
            }
            
            updateUI();

            if(state.eco <= 0 || state.env <= 0 || state.edu <= 0) setTimeout(() => endGame("gameover"), 800);
            else setTimeout(nextTurn, 500);
        }

        function showReaction(dEco, dEnv, dEdu) {
            let type = 'normal';
            if(state.eco<=CONFIG.dangerLine+5 || state.env<=CONFIG.dangerLine+5 || state.edu<=CONFIG.dangerLine+5) type = 'angry';
            else {
                const maxVal = Math.max(dEco, dEnv, dEdu);
                if(maxVal === dEco && dEco > 3) type = 'eco';
                else if(maxVal === dEnv && dEnv > 3) type = 'env';
                else if(maxVal === dEdu && dEdu > 3) type = 'edu';
            }
            const char = characters[type];
            const msg = char.msgs[Math.floor(Math.random()*char.msgs.length)];
            showReactionMsg(msg, type);
        }

        function showReactionMsg(msg, type) {
            const box = document.getElementById('reaction-box');
            document.getElementById('char-msg').textContent = msg;
            box.style.borderLeftColor = characters[type] ? characters[type].color : '#aaa';
        }

        function updateUI() {
            const setBar = (type, val) => {
                const el = document.getElementById(`bar-${type}`);
                const txt = document.getElementById(`val-${type}`);
                const pct = Math.min(100, Math.max(0, (val/CONFIG.maxStat)*100));
                el.style.width = `${pct}%`;
                txt.textContent = val;
                txt.className = val <= CONFIG.dangerLine ? "val-danger" : "";
            };
            setBar('eco', state.eco); setBar('env', state.env); setBar('edu', state.edu);
            document.getElementById('turn-num').textContent = state.turn;

            const total = state.eco + state.env + state.edu;
            const setVisible = (id, show) => {
                const el = document.getElementById(id);
                if(!el) return;
                if(show) { el.classList.remove('hidden'); el.classList.add('visible'); }
                else { el.classList.remove('visible'); el.classList.add('hidden'); }
            };

            // ãƒ¬ãƒ™ãƒ«è¡¨ç¤º
            setVisible('lvl-1', total < 100);
            setVisible('lvl-2', total >= 100 && total < 250);
            setVisible('lvl-3', total >= 250 && total < 400);
            setVisible('lvl-4', total >= 400 && total < 550);
            setVisible('lvl-5', total >= 550);

            // æ°¸ç¶šãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¤º
            state.visuals.forEach(visId => setVisible(visId, true));

            // æ™‚é–“çµŒé
            const timePhase = state.turn % 4;
            const skyRect = document.getElementById('sky-rect');
            const sun = document.getElementById('sun');
            const moon = document.getElementById('moon');
            const timeIcon = document.getElementById('time-icon');
            const windows = document.querySelectorAll('.window-rect');

            if (timePhase === 1) { // Day
                skyRect.setAttribute('fill', "url(#skyDay)"); timeIcon.textContent = "â˜€ï¸";
                sun.setAttribute('opacity', 0.8); moon.setAttribute('opacity', 0);
                setVisible('stars', false);
                windows.forEach(w => w.setAttribute('fill-opacity', 0.6));
            } else if (timePhase === 2) { // Evening
                skyRect.setAttribute('fill', "url(#skyEvening)"); timeIcon.textContent = "ğŸŒ‡";
                sun.setAttribute('opacity', 0.5); moon.setAttribute('opacity', 0);
                setVisible('stars', false);
            } else if (timePhase === 3) { // Night
                skyRect.setAttribute('fill', "url(#skyNight)"); timeIcon.textContent = "ğŸŒ™";
                sun.setAttribute('opacity', 0); moon.setAttribute('opacity', 1);
                setVisible('stars', true);
                windows.forEach(w => { w.setAttribute('fill-opacity', 0.9); w.setAttribute('fill', '#f1c40f'); });
            } else { // Morning
                skyRect.setAttribute('fill', "url(#skyMorning)"); timeIcon.textContent = "ğŸŒ…";
                sun.setAttribute('opacity', 0.6); moon.setAttribute('opacity', 0);
                setVisible('stars', false);
                windows.forEach(w => { w.setAttribute('fill', 'white'); w.setAttribute('fill-opacity', 0.6); });
            }
            
            // ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯BGMèª¿æ•´
            if(state.bgmOn && bgmAudio) {
                 const isDanger = state.eco < 15 || state.env < 15 || state.edu < 15;
                 bgmAudio.playbackRate = isDanger ? 1.15 : 1.0;
            }
        }

        function endGame(type) {
            state.isPlaying = false;
            stopBGM();
            const overlay = document.getElementById('result-screen');
            overlay.classList.add('active');
            
            document.getElementById('res-eco').textContent = state.eco;
            document.getElementById('res-env').textContent = state.env;
            document.getElementById('res-edu').textContent = state.edu;
            const total = state.eco + state.env + state.edu;

            const titleEl = document.getElementById('res-title');
            const rankBadge = document.getElementById('res-rank');
            const mayorTitleEl = document.getElementById('res-mayor-title');
            const fbContainer = document.getElementById('feedback-container');
            fbContainer.innerHTML = "";

            if(type === 'gameover') {
                titleEl.textContent = "GAME OVER";
                titleEl.style.color = "#e74c3c";
                rankBadge.style.display = 'none';
                mayorTitleEl.textContent = "ç§°å·: å¿—åŠã°ã®å¸‚é•·";
                return;
            }

            // ãƒ©ãƒ³ã‚¯åˆ¤å®š
            let rank = "C";
            if(total >= 600) rank = "SSS";
            else if(total >= 500) rank = "S";
            else if(total >= 400) rank = "A";
            else if(total >= 300) rank = "B";

            titleEl.textContent = "CLEAR!";
            rankBadge.style.display = 'inline-block';
            rankBadge.textContent = `RANK ${rank}`;

            // ç§°å·åˆ¤å®š (Collection Element)
            let mTitle = "å¹³å‡¡ãªå¸‚é•·";
            const max = Math.max(state.eco, state.env, state.edu);
            if(total >= 600) mTitle = "ä¼èª¬ã®å‰µé€ ä¸»";
            else if(state.eco > 200) mTitle = "çµŒæ¸ˆã®å·¨äºº";
            else if(state.env > 200) mTitle = "å¤§è‡ªç„¶ã®å®ˆè­·è€…";
            else if(state.edu > 200) mTitle = "è³¢è€…ã®æŒ‡å°è€…";
            else if(Math.abs(state.eco - state.env) < 20 && Math.abs(state.env - state.edu) < 20) mTitle = "ãƒãƒ©ãƒ³ã‚¹ã®é”äºº";
            
            mayorTitleEl.textContent = `ç§°å·: ${mTitle}`;
        }

        document.getElementById('start-btn').onclick = startGame;
        document.getElementById('restart-btn').onclick = startGame; // ãƒªã‚»ãƒƒãƒˆä¿®æ­£
        document.getElementById('bgm-toggle').onclick = toggleBGM;
    </script>
</body>
</html>
