<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#87CEEB">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ç”ºé•·ã‚·ãƒ DX: Living City SE Edition</title>
    <style>
        :root {
            /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆå®šç¾© */
            --c-eco: #f39c12; 
            --c-env: #27ae60; 
            --c-edu: #8e44ad;
            --c-text: #1a202c; 
            --c-bg-glass: rgba(255, 255, 255, 0.92);
            --shadow-soft: 0 8px 30px rgba(0, 0, 0, 0.08);
            --shadow-hard: 0 4px 12px rgba(0, 0, 0, 0.15);
            --radius-L: 24px;
            --radius-M: 16px;
            --radius-S: 12px;
            
            /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®šæ•° */
            --header-h: 64px;
            --sidebar-w: 100px; /* ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ã®ãŸã‚å°‘ã—ç‹­ã */
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* ãƒªã‚»ãƒƒãƒˆ & åŸºæœ¬è¨­å®š */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            touch-action: manipulation;
            user-select: none; /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠé˜²æ­¢ */
            -webkit-user-select: none;
        }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            color: var(--c-text);
            /* ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å¯¾ç­– (Dynamic Viewport Height) */
            height: 100dvh; 
            overflow: hidden;
            transition: background 1.5s ease;
        }

        /* ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠ */
        #app {
            width: 100%;
            height: 100%;
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: relative;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ (ãƒãƒƒãƒå¯¾å¿œ) */
        header {
            height: calc(var(--header-h) + var(--safe-top));
            padding: var(--safe-top) 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.85);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            z-index: 20;
            flex-shrink: 0;
        }

        h1 { 
            margin: 0; 
            font-size: 18px; 
            font-weight: 800; 
            background: linear-gradient(90deg, #2c3e50, #3498db);
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent;
        }

        .turn-badge { 
            font-size: 13px; 
            background: #fff; 
            padding: 6px 14px; 
            border-radius: 20px; 
            font-weight: 700; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            color: #444;
            display: flex; 
            align-items: center; 
            gap: 6px;
        }

        /* ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¸ (ã‚°ãƒªãƒƒãƒ‰) */
        #game-stage {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
            padding-bottom: var(--safe-bottom);
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹) */
        #sidebar {
            width: var(--sidebar-w);
            background: rgba(255,255,255,0.6);
            padding: 16px 12px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border-right: 1px solid rgba(255,255,255,0.4);
            overflow-y: auto;
            flex-shrink: 0;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        main {
            flex: 1;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* iOSæ…£æ€§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ (ç¸¦æŒã¡) */
        @media (max-width: 768px) {
            #game-stage { flex-direction: column; }
            #sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                justify-content: space-evenly;
                padding: 10px 16px;
                background: rgba(255,255,255,0.9);
                border-right: none;
                border-bottom: 1px solid rgba(0,0,0,0.05);
                flex-shrink: 0;
                min-height: 60px;
            }
            .stat-item { flex: 1; max-width: 30%; }
            /* SVGã®é«˜ã•ã‚’ç¢ºä¿ */
            #town-view { aspect-ratio: auto; height: 200px; }
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        .stat-item { display: flex; flex-direction: column; gap: 6px; }
        .stat-header { display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; color: #555; letter-spacing: 0.05em; }
        .progress-track { height: 10px; background: rgba(0,0,0,0.06); border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); border-radius: 6px; }
        
        .fill-eco { background: linear-gradient(90deg, #f1c40f, #e67e22); } 
        .fill-env { background: linear-gradient(90deg, #2ecc71, #27ae60); } 
        .fill-edu { background: linear-gradient(90deg, #9b59b6, #8e44ad); }
        .val-danger { color: #e74c3c; animation: beat 0.5s infinite alternate; }

        /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆ (SVG) */
        #town-view {
            width: 100%; 
            /* PCã§ã¯ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å›ºå®šã€ãƒ¢ãƒã‚¤ãƒ«ã§ã¯å›ºå®šé«˜ã• */
            aspect-ratio: 2.8 / 1;
            background: #87CEEB;
            border-radius: var(--radius-M);
            overflow: hidden; 
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(255,255,255,0.6);
            flex-shrink: 0;
            position: relative;
            transition: background 2s ease;
        }
        #townSvg { width: 100%; height: 100%; display: block; object-fit: cover; }
        .window-rect { transition: fill-opacity 2s ease, fill 2s ease; }

        /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³BOX */
        #reaction-box {
            background: var(--c-bg-glass);
            padding: 12px 16px; 
            border-radius: var(--radius-M);
            box-shadow: var(--shadow-soft);
            display: flex; align-items: center;
            gap: 14px; min-height: 70px; flex-shrink: 0;
            border-left: 5px solid #aaa; 
            transition: border-color 0.4s, transform 0.3s;
        }
        .char-avatar { 
            font-size: 30px; width: 48px; height: 48px; 
            display: flex; align-items: center; justify-content: center; 
            background: #f0f2f5; border-radius: 50%; flex-shrink: 0;
        }
        .reaction-msg { font-size: 13px; line-height: 1.5; font-weight: 600; color: #333; }

        /* é¸æŠè‚¢ã‚¨ãƒªã‚¢ */
        #choices-container {
            display: grid; gap: 12px;
            /* iPhone Xç­‰ã®ãƒ›ãƒ¼ãƒ ãƒãƒ¼å›é¿ã®ãŸã‚ã®ä½™ç™½ */
            padding-bottom: calc(60px + var(--safe-bottom)); 
        }

        /* é¸æŠã‚«ãƒ¼ãƒ‰ (æ”¹å–„ã•ã‚ŒãŸUI) */
        .choice-card {
            background: var(--c-bg-glass);
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: var(--radius-S);
            padding: 14px 18px;
            text-align: left; 
            box-shadow: var(--shadow-soft);
            position: relative; overflow: hidden; 
            cursor: pointer; width: 100%;
            display: flex; flex-direction: column; gap: 4px;
            transition: transform 0.1s, background 0.2s, box-shadow 0.2s;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        .choice-card:active { 
            transform: scale(0.97); 
            background: #fff;
            box-shadow: none;
        }
        .choice-card::before { content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; }
        
        .type-eco::before { background: var(--c-eco); }
        .type-env::before { background: var(--c-env); }
        .type-edu::before { background: var(--c-edu); }
        .type-bal::before { background: #34495e; }

        .choice-title { font-size: 15px; font-weight: 700; color: #2d3748; display: flex; align-items: center; }
        .choice-desc { font-size: 12px; color: #718096; margin-top: 2px; }
        
        .combo-badge { 
            background: linear-gradient(135deg, #f1c40f, #f39c12); 
            color: white; font-size: 10px; padding: 2px 8px; 
            border-radius: 10px; margin-right: 8px; 
            font-weight: 800; box-shadow: 0 2px 5px rgba(241, 196, 15, 0.4);
            animation: pulse 2s infinite;
        }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (Glassmorphism) */
        .screen-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240, 242, 245, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            z-index: 100; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: #333;
            padding: 40px 20px; text-align: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .screen-overlay.active { opacity: 1; pointer-events: auto; }

        /* ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; 
            padding: 16px 40px; border-radius: 50px;
            font-size: 16px; font-weight: 700; letter-spacing: 0.05em;
            box-shadow: 0 10px 30px rgba(118, 75, 162, 0.3);
            cursor: pointer; margin-top: 40px; 
            transition: transform 0.2s, box-shadow 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-primary:active { transform: scale(0.95); box-shadow: 0 5px 15px rgba(118, 75, 162, 0.2); }

        /* BGMãƒœã‚¿ãƒ³ */
        #bgm-toggle {
            position: absolute; bottom: calc(20px + var(--safe-bottom)); right: 20px;
            width: 48px; height: 48px; border-radius: 50%;
            background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border: none; font-size: 22px; z-index: 90; cursor: pointer;
            transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        #bgm-toggle:active { transform: scale(0.9); }

        /* çµæœç”»é¢ */
        .score-board {
            display: flex; gap: 20px; margin: 30px 0;
            background: white; padding: 24px; border-radius: var(--radius-L);
            box-shadow: var(--shadow-soft);
            width: 100%; max-width: 400px;
            justify-content: space-around;
        }
        .score-item { display: flex; flex-direction: column; align-items: center; }
        .score-val { font-size: 24px; font-weight: 800; font-family: monospace; }
        .score-label { font-size: 11px; color: #888; margin-top: 4px; font-weight: 700; }
        
        .feedback-card {
            background: white; padding: 16px; border-radius: var(--radius-M);
            box-shadow: var(--shadow-soft);
            max-width: 100%; width: 400px; text-align: left;
            display: flex; gap: 16px; align-items: flex-start;
            margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.03);
        }
        .fb-icon { font-size: 32px; background: #f8f9fa; padding: 8px; border-radius: 50%; flex-shrink: 0; }
        .fb-content { flex: 1; }
        .fb-name { font-weight: 700; font-size: 13px; color: #555; margin-bottom: 4px; }
        .fb-text { font-size: 14px; line-height: 1.6; color: #333; }
        
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .sway { animation: sway 3s ease-in-out infinite; transform-origin: bottom center; transform-box: fill-box; }
        .float { animation: float 6s ease-in-out infinite; transform-box: fill-box; }
        .drive { animation: drive linear infinite; }
        .fly { animation: fly linear infinite; }
        .twinkle { animation: twinkle 3s ease-in-out infinite; }
        
        @keyframes sway { 0%,100% { transform: rotate(-2deg); } 50% { transform: rotate(2deg); } }
        @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes drive { from { transform: translateX(-150px); } to { transform: translateX(850px); } }
        @keyframes fly { from { transform: translateX(900px); } to { transform: translateX(-200px); } }
        @keyframes twinkle { 0%,100% { opacity: 0.3; } 50% { opacity: 1; } }

        .hidden { opacity: 0; pointer-events: none; transition: opacity 0.8s; } 
        .visible { opacity: 1; transition: opacity 0.8s; }
        .emergency-mode header { border-bottom: 3px solid #e74c3c; animation: flash 1s infinite; }
        @keyframes flash { 50% { border-color: transparent; } }
    </style>
</head>
<body>

    <div id="app">
        <header>
            <h1>ğŸŒ† ç”ºé•·ã‚·ãƒ DX <span style="font-size:0.6em; opacity:0.6; font-weight:normal;">SE Ed.</span></h1>
            <div class="turn-badge">
                <span id="time-icon">â˜€ï¸</span>
                <span>TURN <span id="turn-num">1</span>/<span id="max-turn">30</span></span>
            </div>
        </header>

        <div id="game-stage">
            <aside id="sidebar">
                <div class="stat-item">
                    <div class="stat-header"><span>ğŸ’°çµŒæ¸ˆ</span><span id="val-eco">10</span></div>
                    <div class="progress-track"><div class="progress-fill fill-eco" id="bar-eco"></div></div>
                </div>
                <div class="stat-item">
                    <div class="stat-header"><span>ğŸŒ¿ç’°å¢ƒ</span><span id="val-env">10</span></div>
                    <div class="progress-track"><div class="progress-fill fill-env" id="bar-env"></div></div>
                </div>
                <div class="stat-item">
                    <div class="stat-header"><span>ğŸ“šæ•™è‚²</span><span id="val-edu">10</span></div>
                    <div class="progress-track"><div class="progress-fill fill-edu" id="bar-edu"></div></div>
                </div>
            </aside>

            <main>
                <div id="town-view">
                    <svg id="townSvg" viewBox="0 0 800 320" preserveAspectRatio="xMidYMid slice">
                        <defs>
                            <linearGradient id="skyMorning" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#FF9A9E"/><stop offset="100%" stop-color="#FECFEF"/></linearGradient>
                            <linearGradient id="skyDay" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#87CEEB"/><stop offset="100%" stop-color="#E0F7FA"/></linearGradient>
                            <linearGradient id="skyEvening" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#FF7F50"/><stop offset="100%" stop-color="#4b6cb7"/></linearGradient>
                            <linearGradient id="skyNight" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#0f2027"/><stop offset="100%" stop-color="#2c5364"/></linearGradient>
                            <linearGradient id="grass" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#7CFC00"/><stop offset="100%" stop-color="#32CD32"/></linearGradient>
                            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur in="SourceAlpha" stdDeviation="2"/><feOffset dx="2" dy="2" result="offsetblur"/><feComponentTransfer><feFuncA type="linear" slope="0.3"/></feComponentTransfer><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                            <pattern id="win-pattern" width="10" height="15" patternUnits="userSpaceOnUse"><rect class="window-rect" width="6" height="10" fill="white" fill-opacity="0.6"/></pattern>
                        </defs>
                        
                        <rect id="sky-rect" width="800" height="320" fill="url(#skyDay)" style="transition: fill 2s ease;" />
                        
                        <g id="stars" class="hidden">
                            <circle cx="100" cy="50" r="1.5" fill="white" class="twinkle" style="animation-delay:0s"/>
                            <circle cx="300" cy="80" r="1.5" fill="white" class="twinkle" style="animation-delay:1s"/>
                            <circle cx="500" cy="40" r="1.5" fill="white" class="twinkle" style="animation-delay:0.5s"/>
                            <circle cx="700" cy="90" r="1.5" fill="white" class="twinkle" style="animation-delay:2s"/>
                        </g>

                        <circle id="sun" cx="700" cy="50" r="40" fill="#FFD700" opacity="0.8" style="filter:url(#shadow); transition: opacity 2s ease;"/>
                        <circle id="moon" cx="100" cy="50" r="30" fill="#F4F6F0" opacity="0" style="filter:url(#shadow); transition: opacity 2s ease;"/>

                        <g class="fly" style="animation-duration: 60s; opacity: 0.8;"><path d="M50,80 Q70,50 100,80 T160,80" stroke="white" stroke-width="30" stroke-linecap="round" fill="none"/></g>
                        <g transform="translate(0, 50)"><g class="fly" style="animation-duration: 45s; animation-delay: -20s; opacity: 0.6; transform-origin: center;"><g transform="scale(0.7)"><path d="M400,60 Q430,30 460,60 T520,60" stroke="white" stroke-width="25" stroke-linecap="round" fill="none"/></g></g></g>

                        <rect y="220" width="800" height="100" fill="url(#grass)" />
                        <rect y="250" width="800" height="50" fill="#555" />
                        <line x1="0" y1="275" x2="800" y2="275" stroke="#fff" stroke-width="2" stroke-dasharray="30,30"/>

                        <g id="lvl-1" class="visible">
                            <g transform="translate(100, 200)">
                                <rect x="0" y="20" width="60" height="40" fill="#DEB887" stroke="#8B4513" stroke-width="2"/>
                                <path d="M-10,20 L30,-10 L70,20 Z" fill="#A52A2A" stroke="#5d4037" stroke-width="2"/>
                                <rect x="20" y="35" width="20" height="25" fill="#6d4c41"/>
                            </g>
                            <g transform="translate(50, 190)"><g class="sway"><rect x="5" y="30" width="10" height="40" fill="#8B4513"/><circle cx="10" cy="20" r="25" fill="#228B22"/></g></g>
                            <g transform="translate(700, 180)"><g class="sway" style="animation-delay: -1s;"><rect x="5" y="30" width="10" height="50" fill="#8B4513"/><circle cx="10" cy="20" r="30" fill="#006400"/></g></g>
                            <g transform="translate(200, 240)"><circle cx="0" cy="-10" r="6" fill="#333"/><path d="M-5,0 L5,0 L0,15 Z" fill="#e67e22"/></g>
                        </g>

                        <g id="lvl-2" class="hidden">
                            <g transform="translate(300, 180)">
                                <rect x="0" y="20" width="100" height="60" fill="#fce4ec" stroke="#ec407a" stroke-width="2"/>
                                <rect x="0" y="0" width="100" height="20" fill="#ec407a"/>
                                <text x="50" y="15" text-anchor="middle" fill="white" font-weight="bold" font-size="12">SHOP</text>
                                <rect x="20" y="40" width="60" height="40" fill="rgba(255,255,255,0.6)"/>
                            </g>
                            <g class="drive" style="animation-duration: 10s;">
                                <rect x="0" y="260" width="60" height="20" rx="6" fill="#3498db"/>
                                <rect x="10" y="250" width="40" height="15" rx="3" fill="#85c1e9"/>
                                <circle cx="15" cy="280" r="7" fill="#333"/>
                                <circle cx="45" cy="280" r="7" fill="#333"/>
                            </g>
                            <g transform="translate(420, 240)"><circle cx="0" cy="-10" r="6" fill="#555"/><path d="M-5,0 L5,0 L0,15 Z" fill="#9b59b6"/></g>
                            <g transform="translate(440, 245) scale(0.9)"><circle cx="0" cy="-10" r="6" fill="#555"/><path d="M-5,0 L5,0 L0,15 Z" fill="#f1c40f"/></g>
                        </g>

                        <g id="lvl-3" class="hidden">
                            <rect x="500" y="100" width="80" height="150" fill="#95a5a6" stroke="#7f8c8d" stroke-width="2"/>
                            <rect x="510" y="110" width="60" height="130" fill="url(#win-pattern)"/>
                            <rect x="150" y="80" width="100" height="170" fill="#34495e" stroke="#2c3e50" stroke-width="2"/>
                            <rect x="160" y="90" width="80" height="150" fill="url(#win-pattern)"/>
                            <g class="drive" style="animation-duration: 12s; animation-delay: -5s;">
                                <rect x="0" y="245" width="100" height="35" rx="4" fill="#f1c40f"/>
                                <rect x="5" y="250" width="20" height="15" fill="#333"/>
                                <rect x="30" y="250" width="20" height="15" fill="#333"/>
                                <rect x="55" y="250" width="20" height="15" fill="#333"/>
                                <circle cx="20" cy="280" r="7" fill="#333"/>
                                <circle cx="80" cy="280" r="7" fill="#333"/>
                            </g>
                            <g transform="translate(580, 245)"><circle cx="0" cy="-10" r="5" fill="#333"/><path d="M-4,0 L4,0 L0,14 Z" fill="#34495e"/></g>
                            <g transform="translate(600, 245)"><circle cx="0" cy="-10" r="5" fill="#333"/><path d="M-4,0 L4,0 L0,14 Z" fill="#34495e"/></g>
                            <g transform="translate(620, 245)"><circle cx="0" cy="-10" r="5" fill="#333"/><path d="M-4,0 L4,0 L0,14 Z" fill="#e74c3c"/></g>
                        </g>

                        <g id="lvl-4" class="hidden">
                            <rect x="350" y="20" width="120" height="230" fill="#8e44ad" opacity="0.9"/>
                            <rect x="360" y="30" width="100" height="210" fill="url(#win-pattern)"/>
                            <g transform="translate(0, 50)"><g class="fly" style="animation-duration: 20s;"><path d="M0,0 L40,-10 L50,0 L40,10 Z" fill="#ecf0f1" stroke="#bdc3c7"/><rect x="20" y="-15" width="10" height="15" fill="#bdc3c7"/></g></g>
                            <g transform="translate(300, 245)"><circle cx="0" cy="-10" r="5" fill="#333"/><path d="M-4,0 L4,0 L0,14 Z" fill="#2c3e50"/></g>
                            <g transform="translate(320, 240)"><circle cx="0" cy="-10" r="5" fill="#333"/><path d="M-4,0 L4,0 L0,14 Z" fill="#8e44ad"/></g>
                            <g transform="translate(340, 248)"><circle cx="0" cy="-10" r="5" fill="#333"/><path d="M-4,0 L4,0 L0,14 Z" fill="#16a085"/></g>
                        </g>

                        <g id="lvl-5" class="hidden">
                            <path d="M650,250 L680,50 L720,50 L750,250 Z" fill="#00bcd4" opacity="0.8"/>
                            <rect x="680" y="50" width="40" height="200" fill="url(#win-pattern)"/>
                            <path d="M0,150 Q400,100 800,150" stroke="rgba(255,255,255,0.5)" stroke-width="12" fill="none"/>
                            <g transform="translate(400, 80)"><g class="float"><circle cx="0" cy="0" r="10" fill="#333"/><line x1="-15" y1="0" x2="15" y2="0" stroke="#333" stroke-width="2"/><circle cx="-15" cy="0" r="4" fill="#95a5a6"/><circle cx="15" cy="0" r="4" fill="#95a5a6"/><circle cx="0" cy="0" r="4" fill="#e74c3c" class="val-danger"/></g></g>
                            <g transform="translate(700, 240)"><circle cx="0" cy="-10" r="6" fill="#bdc3c7"/><path d="M-5,0 L5,0 L0,15 Z" fill="#7f8c8d"/></g>
                            <g transform="translate(730, 240)"><circle cx="0" cy="-10" r="6" fill="#bdc3c7"/><path d="M-5,0 L5,0 L0,15 Z" fill="#3498db"/></g>
                        </g>

                        <g id="spec-eco" class="hidden" transform="translate(580, 50)"><text x="0" y="0" font-size="40">ğŸ’¹</text></g>
                        <g id="spec-env" class="hidden" transform="translate(50, 100)"><text x="0" y="0" font-size="40">ğŸŒ³</text></g>
                        <g id="spec-edu" class="hidden" transform="translate(250, 60)"><text x="0" y="0" font-size="40">ğŸ›°ï¸</text></g>
                    </svg>
                </div>

                <div id="reaction-box">
                    <div class="char-avatar">ğŸ‘¨â€ğŸ’¼</div>
                    <div class="reaction-msg" id="char-msg">å¸‚é•·ã€å°±ä»»ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<br>30ã‚¿ãƒ¼ãƒ³ã®ä»»æœŸã§æœ€é«˜ã®ç”ºã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚</div>
                </div>

                <div id="choices-container"></div>
            </main>
        </div>

        <button id="bgm-toggle" style="display:none;">ğŸ”Š</button>

        <div id="start-screen" class="screen-overlay active">
            <h1 style="font-size: 2.5em; margin-bottom: 20px;">ğŸ™ï¸ ç”ºé•·ã‚·ãƒ DX</h1>
            <p style="font-size: 1.1em; color: #555; font-weight: 500;">Living City SE Edition</p>
            <p style="margin: 30px 0; line-height: 2; font-size: 0.95em;">
                çµŒæ¸ˆãƒ»ç’°å¢ƒãƒ»æ•™è‚²ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚ŠãªãŒã‚‰<br>
                30ã‚¿ãƒ¼ãƒ³ã§ç†æƒ³ã®éƒ½å¸‚ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚<br>
                æ™‚é–“å¤‰åŒ–ã¨ä½æ°‘ã®ç”Ÿæ´»ãŒã“ã“ã«ã‚ã‚Šã¾ã™ã€‚
            </p>
            <button class="btn-primary" id="start-btn">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>

        <div id="result-screen" class="screen-overlay">
            <h2 id="res-title" style="font-size:2.2em; margin:0 0 10px 0; color:#2c3e50;">CLEAR!</h2>
            <div class="rank-badge" id="res-rank">RANK A</div>
            <p id="res-desc" style="font-size:1em; margin-bottom:20px; color:#666;">ä»»æœŸæº€äº†ï¼æœ€çµ‚çµæœãƒ¬ãƒãƒ¼ãƒˆ</p>
            
            <div class="score-board">
                <div class="score-item"><span class="score-val" style="color:var(--c-eco)" id="res-eco">0</span><span class="score-label">çµŒæ¸ˆ</span></div>
                <div class="score-item"><span class="score-val" style="color:var(--c-env)" id="res-env">0</span><span class="score-label">ç’°å¢ƒ</span></div>
                <div class="score-item"><span class="score-val" style="color:var(--c-edu)" id="res-edu">0</span><span class="score-label">æ•™è‚²</span></div>
            </div>
            <div style="font-size:1.2em; font-weight:bold; margin-bottom:20px;">ç·åˆã‚¹ã‚³ã‚¢: <span id="res-total">0</span></div>

            <div id="feedback-container"></div>
            <button class="btn-primary" id="restart-btn">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        // === Game Config ===
        const CONFIG = { maxTurns: 30, dangerLine: 10, maxStat: 250 };
        document.getElementById('max-turn').textContent = CONFIG.maxTurns;
        
        // === Data Sets ===
        const choicePool = [
            { id: 'market', type: 'eco', text: "é’ç©ºå¸‚å ´ã®é–‹å‚¬", eco: 5, env: 1, edu: 1, desc: "åœ°å…ƒã®ç‰¹ç”£å“ã‚’è²©å£²" },
            { id: 'bus', type: 'bal', text: "ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒã‚¹", eco: -2, env: 3, edu: 1, desc: "é«˜é½¢è€…ã®è¶³ã‚’ç¢ºä¿" },
            { id: 'clean', type: 'env', text: "ã‚´ãƒŸæ‹¾ã„æ´»å‹•", eco: 0, env: 5, edu: 1, desc: "è¡—ã‚’ãã‚Œã„ã«ã™ã‚‹" },
            { id: 'repair', type: 'edu', text: "å…¬æ°‘é¤¨ã®ä¿®ç¹•", eco: -2, env: 0, edu: 5, desc: "å­¦ã³ã®å ´ã‚’å®ˆã‚‹" },
            { id: 'factory', type: 'eco', text: "å·¥å ´èª˜è‡´", eco: 10, env: -5, edu: 0, desc: "é›‡ç”¨å¢—ãƒ»ç’°å¢ƒè² è·å¢—", comboText:"å·¥æ¥­åœ°å¸¯" },
            { id: 'mall', type: 'eco', text: "å¤§å‹ãƒ¢ãƒ¼ãƒ«å»ºè¨­", eco: 12, env: -4, edu: 1, desc: "å•†æ¥­æ´»æ€§åŒ–", comboText:"å•†æ¥­ãƒãƒ–" },
            { id: 'it_park', type: 'eco', text: "ITãƒ‘ãƒ¼ã‚¯å»ºè¨­", eco: 10, env: -2, edu: 3, desc: "ãƒã‚¤ãƒ†ã‚¯é›†ç©", comboText:"ã‚·ãƒªã‚³ãƒ³ãƒãƒ¬ãƒ¼" },
            { id: 'solar', type: 'env', text: "ã‚½ãƒ¼ãƒ©ãƒ¼ç™ºé›»æ‰€", eco: -3, env: 8, edu: 2, desc: "ã‚¯ãƒªãƒ¼ãƒ³ã‚¨ãƒãƒ«ã‚®ãƒ¼", comboText:"ã‚¨ã‚³ã‚¿ã‚¦ãƒ³" },
            { id: 'park_big', type: 'env', text: "å¤§è¦æ¨¡å…¬åœ’", eco: -4, env: 10, edu: 2, desc: "æ†©ã„ã®å ´", comboText:"æ£®æ—éƒ½å¸‚" },
            { id: 'recycle', type: 'env', text: "ãƒªã‚µã‚¤ã‚¯ãƒ«å·¥å ´", eco: 2, env: 9, edu: 3, desc: "è³‡æºå†åˆ©ç”¨", comboText:"å¾ªç’°ç¤¾ä¼š" },
            { id: 'library', type: 'edu', text: "ä¸­å¤®å›³æ›¸é¤¨", eco: -3, env: 1, edu: 10, desc: "çŸ¥ã®æ‹ ç‚¹", comboText:"å­¦è¡“éƒ½å¸‚" },
            { id: 'univ', type: 'edu', text: "å¤§å­¦ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹", eco: 5, env: -2, edu: 15, req: 'library', desc: "é«˜ç­‰æ•™è‚²æ©Ÿé–¢", comboText:"ç ”ç©¶éƒ½å¸‚" },
            { id: 'tablet', type: 'edu', text: "ICTæ•™è‚²å°å…¥", eco: -4, env: 1, edu: 8, desc: "å…¨ç”Ÿå¾’ã«ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ", comboText:"ãƒ‡ã‚¸ã‚¿ãƒ«æ•™è‚²" },
            { id: 'festival', type: 'bal', text: "å¤§èŠ±ç«å¤§ä¼š", eco: 8, env: -2, edu: 1, desc: "è¦³å…‰å®¢èª˜è‡´" },
            { id: 'hospital', type: 'bal', text: "ç·åˆç—…é™¢", eco: -5, env: 2, edu: 4, desc: "å¥åº·ã‚’å®ˆã‚‹" },
            { id: 'smart', type: 'bal', text: "ã‚¹ãƒãƒ¼ãƒˆã‚·ãƒ†ã‚£åŒ–", eco: 10, env: 8, edu: 8, req: 'it_park', desc: "éƒ½å¸‚OSã§æœ€é©åŒ–", comboText:"æœªæ¥éƒ½å¸‚" }
        ];

        const characters = {
            eco: { icon: "ğŸ‘”", color: "#f39c12", msgs: ["æ ªä¾¡ãŒä¸ŠãŒã£ã¦ã„ã¾ã™ï¼", "ãƒ“ã‚¸ãƒã‚¹ãƒãƒ£ãƒ³ã‚¹åˆ°æ¥ã§ã™ã€‚", "ç¨åã‚¢ãƒƒãƒ—ã¯ç´ æ™´ã‚‰ã—ã„ã€‚"] },
            env: { icon: "ğŸŒ¿", color: "#27ae60", msgs: ["ç·‘ãŒå¢—ãˆã¦æ°—æŒã¡ã„ã„ã§ã™ã­ã€‚", "ç©ºæ°—ãŒãŠã„ã—ã„ã§ã™ã€‚", "å‹•ç‰©ãŸã¡ã‚‚å–œã‚“ã§ã„ã¾ã™ã€‚"] },
            edu: { icon: "ğŸ“", color: "#8e44ad", msgs: ["ç´ æ™´ã‚‰ã—ã„æ•™è‚²ç’°å¢ƒã§ã™ã€‚", "å­¦ç”ŸãŒå¢—ãˆã¦ã„ã¾ã™ã‚ˆã€‚", "çŸ¥çš„ãªè¡—ã«ãªã‚Šã¾ã—ãŸã­ã€‚"] },
            normal: { icon: "ğŸ‘©", color: "#666", msgs: ["ä½ã¿ã‚„ã™ã„è¡—ã§ã™ã­ã€‚", "æœ€è¿‘æ´»æ°—ãŒã‚ã‚Šã¾ã™ã€‚", "å¸‚é•·ã€æœŸå¾…ã—ã¦ã¾ã™ã‚ˆï¼"] },
            angry: { icon: "ğŸ˜¡", color: "#c0392b", msgs: ["ã¡ã‚‡ã£ã¨ï¼ç”Ÿæ´»ãŒè‹¦ã—ã„ã‚ï¼", "ç’°å¢ƒç ´å£Šã‚’æ­¢ã‚ã¦ï¼", "å¸‚é•·ã¯ä½•ã‚’è€ƒãˆã¦ã„ã‚‹ã®ï¼ï¼Ÿ"] }
        };

        const feedbacks = {
            perfect: { icon: "ğŸ†", name: "ä¼èª¬ã®å¸‚é•·ã¸", msg: "çµŒæ¸ˆã€ç’°å¢ƒã€æ•™è‚²â€¦å…¨ã¦ã«ãŠã„ã¦å®Œç’§ãªèª¿å’Œã§ã™ï¼ã‚ãªãŸã®åå‰ã¯ã“ã®è¡—ã®æ­´å²ã«æ°¸é ã«åˆ»ã¾ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚" },
            balanced: { icon: "ğŸ‘µ", name: "è¡—ã®é•·è€", msg: "é•·ç”Ÿãã¯ã™ã‚‹ã‚‚ã‚“ã˜ã‚ƒã€‚ã“ã‚“ãªã«ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„ä½ã¿ã‚ˆã„è¡—ã«ãªã‚‹ã¨ã¯ã®ã†ã€‚ã‚ã‚ŠãŒã¨ã†ã€å¸‚é•·ã•ã‚“ã€‚" },
            eco_master: { icon: "ğŸ¤‘", name: "æŠ•è³‡å®¶", msg: "ç´ æ™´ã‚‰ã—ã„çµŒæ¸ˆæˆé•·ã ï¼è¡—ã¯ãƒ“ãƒ«ã§åŸ‹ã‚å°½ãã•ã‚Œã€é‡‘ãŒå”¸ã£ã¦ã„ã‚‹ã€‚ç’°å¢ƒï¼Ÿãã‚“ãªã“ã¨ã‚ˆã‚Šåˆ©ç›Šã ã‚ˆï¼" },
            env_master: { icon: "ğŸ•", name: "ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢æ„›å¥½å®¶", msg: "ã¾ã‚‹ã§æ£®ã®ä¸­ã«ä½ã‚“ã§ã„ã‚‹ã‚ˆã†ã§ã™ï¼å°‘ã—ä¸ä¾¿ã§ã™ãŒã€ã“ã®è±Šã‹ãªè‡ªç„¶ã¯ä½•ã«ã‚‚ä»£ãˆãŒãŸã„å®ç‰©ã§ã™ã­ã€‚" },
            edu_master: { icon: "ğŸ¤–", name: "AIç ”ç©¶è€…", msg: "æ¥µã‚ã¦è«–ç†çš„ã§çŸ¥çš„ãªéƒ½å¸‚è¨­è¨ˆã§ã™ã€‚ä½æ°‘ã®IQã‚‚å¹³å‡ã‚ˆã‚Šé«˜ãã€æœªæ¥ã®æŠ€è¡“ãŒã“ã“ã‹ã‚‰ç”Ÿã¾ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚" },
            eco_env: { icon: "ğŸ™", name: "éƒ½å¸‚è¨ˆç”»å®¶", msg: "çµŒæ¸ˆã¨è‡ªç„¶ãŒè¦‹äº‹ã«èåˆã—ã¦ã„ã¾ã™ã€‚ã‚°ãƒªãƒ¼ãƒ³ã‚¨ã‚³ãƒãƒŸãƒ¼ã®æˆåŠŸä¾‹ã¨ã—ã¦ä¸–ç•Œä¸­ã‹ã‚‰æ³¨ç›®ã•ã‚Œã¦ã„ã¾ã™ã‚ˆã€‚" },
            poor: { icon: "ğŸš", name: "å»ã£ã¦ã„ãä½æ°‘", msg: "ã‚‚ã†ã“ã®è¡—ã«ã¯å¸Œæœ›ãŒã‚ã‚Šã¾ã›ã‚“â€¦ã€‚ä»•äº‹ã‚‚ãªã„ã€è‡ªç„¶ã‚‚ãªã„ã€‚ç§ãŸã¡ã¯ä»–ã®è¡—ã¸å¼•ã£è¶Šã—ã¾ã™ã€‚ã•ã‚ˆã†ãªã‚‰ã€‚" }
        };

        let state = { eco: 20, env: 20, edu: 20, turn: 0, lastChoice: null, bgmOn: false, isPlaying: false };

        const AudioSys = {
            ctx: null,
            init: function() {
                if(!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
                if(this.ctx.state === 'suspended') this.ctx.resume();
            },
            playTone: function(freq, type, duration, vol=0.1) {
                if(!this.ctx || this.ctx.state !== 'running') return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playTap: () => AudioSys.playTone(800, 'sine', 0.1, 0.05),
            playCombo: () => { [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => setTimeout(() => AudioSys.playTone(f, 'triangle', 0.3, 0.1), i * 80)); },
            playDanger: () => AudioSys.playTone(150, 'sawtooth', 0.4, 0.1),
            playStart: () => AudioSys.playTone(1046.50, 'sine', 0.5, 0.2)
        };

        let bgmAudio = null;
        function initBGM() {
            if (!bgmAudio) {
                bgmAudio = new Audio('town.mp3');
                bgmAudio.loop = true;
                bgmAudio.volume = 0.3;
            }
        }
        function playBGM() {
            if (!bgmAudio) initBGM();
            if (state.bgmOn && state.isPlaying && bgmAudio) bgmAudio.play().catch(e => console.log('BGM Error', e));
        }
        function stopBGM() { if (bgmAudio) { bgmAudio.pause(); bgmAudio.currentTime = 0; } }
        function toggleBGM() {
            AudioSys.init();
            state.bgmOn = !state.bgmOn;
            document.getElementById('bgm-toggle').textContent = state.bgmOn ? "ğŸ”Š" : "ğŸ”‡";
            if (state.bgmOn && state.isPlaying) playBGM(); else stopBGM();
        }

        function startGame() {
            AudioSys.init();
            AudioSys.playStart();
            state = { eco: 20, env: 20, edu: 20, turn: 0, lastChoice: null, bgmOn: true, isPlaying: true };
            document.getElementById('start-screen').classList.remove('active');
            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('bgm-toggle').style.display = 'flex';
            document.getElementById('bgm-toggle').textContent = "ğŸ”Š";
            document.body.classList.remove('emergency-mode');
            updateUI();
            initBGM();
            playBGM();
            nextTurn();
        }

        function resetToTitle() {
            state.isPlaying = false;
            stopBGM();
            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('start-screen').classList.add('active');
            document.getElementById('bgm-toggle').style.display = 'none';
        }

        function nextTurn() {
            if(state.turn >= CONFIG.maxTurns) { endGame("clear"); return; }
            state.turn++;
            updateUI();
            renderChoices();
        }

        function renderChoices() {
            const container = document.getElementById('choices-container');
            container.innerHTML = "";
            let candidates = [...choicePool];
            let selected = [];
            
            const comboIdx = candidates.findIndex(c => c.req === state.lastChoice);
            if(comboIdx >= 0) {
                let c = candidates.splice(comboIdx, 1)[0];
                c.isCombo = true;
                selected.push(c);
            }
            while(selected.length < 3 && candidates.length > 0) {
                const idx = Math.floor(Math.random() * candidates.length);
                const c = candidates.splice(idx, 1)[0];
                if(c.req && c.req !== state.lastChoice) continue; 
                selected.push(c);
            }

            selected.forEach(c => {
                const btn = document.createElement('button');
                btn.className = `choice-card type-${c.type}`;
                const comboHtml = c.isCombo ? `<span class="combo-badge">â˜…COMBO</span>` : '';
                btn.innerHTML = `
                    <div class="choice-title">${comboHtml}${c.text}</div>
                    <div class="choice-desc">${c.isCombo ? c.comboText : c.desc}</div>
                `;
                btn.onclick = () => {
                    // ã‚¿ãƒƒãƒ—æ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                    btn.style.transform = "scale(0.97)";
                    if (navigator.vibrate) navigator.vibrate(5);
                    setTimeout(() => processChoice(c), 150);
                };
                container.appendChild(btn);
            });
        }

        function processChoice(c) {
            AudioSys.init();
            if(c.isCombo) AudioSys.playCombo(); else AudioSys.playTap();
            const bonus = c.isCombo ? 5 : 0;
            state.eco += c.eco + bonus;
            state.env += c.env + bonus;
            state.edu += c.edu + bonus;
            state.lastChoice = c.id;

            showReaction(c.eco, c.env, c.edu);
            updateUI();

            if(state.eco <= 0 || state.env <= 0 || state.edu <= 0) setTimeout(() => endGame("gameover"), 800);
            else setTimeout(nextTurn, 500); // ã‚¿ãƒ¼ãƒ³é·ç§»ã‚’å°‘ã—æ—©ã
        }

        function showReaction(dEco, dEnv, dEdu) {
            const avatar = document.querySelector('.char-avatar');
            const msgEl = document.getElementById('char-msg');
            const box = document.getElementById('reaction-box');
            let type = 'normal';
            if(state.eco<=CONFIG.dangerLine+5 || state.env<=CONFIG.dangerLine+5 || state.edu<=CONFIG.dangerLine+5) type = 'angry';
            else {
                const maxVal = Math.max(dEco, dEnv, dEdu);
                if(maxVal === dEco && dEco > 3) type = 'eco';
                else if(maxVal === dEnv && dEnv > 3) type = 'env';
                else if(maxVal === dEdu && dEdu > 3) type = 'edu';
            }
            const char = characters[type];
            avatar.textContent = char.icon;
            msgEl.textContent = char.msgs[Math.floor(Math.random()*char.msgs.length)];
            box.style.borderLeftColor = char.color;
        }

        function updateUI() {
            const setBar = (type, val) => {
                const el = document.getElementById(`bar-${type}`);
                const txt = document.getElementById(`val-${type}`);
                const pct = Math.min(100, Math.max(0, (val/CONFIG.maxStat)*100));
                el.style.width = `${pct}%`;
                txt.textContent = val;
                txt.className = val <= CONFIG.dangerLine ? "val-danger" : "";
            };
            setBar('eco', state.eco); setBar('env', state.env); setBar('edu', state.edu);
            document.getElementById('turn-num').textContent = state.turn;

            const total = state.eco + state.env + state.edu;
            const setVisible = (id, show) => {
                const el = document.getElementById(id);
                if(show) { el.classList.remove('hidden'); el.classList.add('visible'); }
                else { el.classList.remove('visible'); el.classList.add('hidden'); }
            };

            setVisible('lvl-1', total < 100);
            setVisible('lvl-2', total >= 100 && total < 250);
            setVisible('lvl-3', total >= 250 && total < 400);
            setVisible('lvl-4', total >= 400 && total < 550);
            setVisible('lvl-5', total >= 550);

            setVisible('spec-eco', state.eco > 150);
            setVisible('spec-env', state.env > 150);
            setVisible('spec-edu', state.edu > 150);

            // Time Phase Logic
            const timePhase = state.turn % 4;
            const skyRect = document.getElementById('sky-rect');
            const sun = document.getElementById('sun');
            const moon = document.getElementById('moon');
            const timeIcon = document.getElementById('time-icon');
            const windows = document.querySelectorAll('.window-rect');

            let skyUrl = "";
            let iconStr = "";
            
            if (timePhase === 1) { // Day
                skyUrl = "url(#skyDay)"; iconStr = "â˜€ï¸";
                sun.setAttribute('opacity', 0.8); moon.setAttribute('opacity', 0);
                setVisible('stars', false);
                windows.forEach(w => w.setAttribute('fill-opacity', 0.6));
                document.body.style.background = "linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)";
            } else if (timePhase === 2) { // Evening
                skyUrl = "url(#skyEvening)"; iconStr = "ğŸŒ‡";
                sun.setAttribute('opacity', 0.5); moon.setAttribute('opacity', 0);
                setVisible('stars', false);
                windows.forEach(w => w.setAttribute('fill-opacity', 0.6));
                document.body.style.background = "linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%)";
            } else if (timePhase === 3) { // Night
                skyUrl = "url(#skyNight)"; iconStr = "ğŸŒ™";
                sun.setAttribute('opacity', 0); moon.setAttribute('opacity', 1);
                setVisible('stars', true);
                windows.forEach(w => { w.setAttribute('fill-opacity', 0.9); w.setAttribute('fill', '#f1c40f'); });
                document.body.style.background = "linear-gradient(135deg, #09203f 0%, #537895 100%)";
            } else { // Morning
                skyUrl = "url(#skyMorning)"; iconStr = "ğŸŒ…";
                sun.setAttribute('opacity', 0.6); moon.setAttribute('opacity', 0);
                setVisible('stars', false);
                windows.forEach(w => { w.setAttribute('fill', 'white'); w.setAttribute('fill-opacity', 0.6); });
                document.body.style.background = "linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)";
            }
            
            skyRect.setAttribute('fill', skyUrl);
            timeIcon.textContent = iconStr;

            if(state.eco<=CONFIG.dangerLine || state.env<=CONFIG.dangerLine || state.edu<=CONFIG.dangerLine) {
                document.body.classList.add('emergency-mode');
                if(state.bgmOn) AudioSys.playDanger();
            } else {
                document.body.classList.remove('emergency-mode');
            }
        }

        function endGame(type) {
            state.isPlaying = false;
            stopBGM();
            const overlay = document.getElementById('result-screen');
            overlay.classList.add('active');
            
            document.getElementById('res-eco').textContent = state.eco;
            document.getElementById('res-env').textContent = state.env;
            document.getElementById('res-edu').textContent = state.edu;
            const total = state.eco + state.env + state.edu;
            document.getElementById('res-total').textContent = total;

            const title = document.getElementById('res-title');
            const rankBadge = document.getElementById('res-rank');
            const fbContainer = document.getElementById('feedback-container');
            fbContainer.innerHTML = "";

            let rank = "C";
            if(total >= 600) rank = "SSS";
            else if(total >= 500) rank = "S";
            else if(total >= 400) rank = "A";
            else if(total >= 300) rank = "B";

            if(type === 'gameover') {
                title.textContent = "GAME OVER";
                title.style.color = "#e74c3c";
                rankBadge.style.display = 'none';
                renderFeedback('poor');
            } else {
                title.textContent = "CLEAR!";
                title.style.color = "#2c3e50";
                rankBadge.style.display = 'inline-block';
                rankBadge.textContent = `RANK ${rank}`;
                
                if(rank === 'SSS') renderFeedback('perfect');
                else {
                    const vals = [state.eco, state.env, state.edu];
                    const diff = Math.max(...vals) - Math.min(...vals);
                    if(diff < 50) renderFeedback('balanced');
                    else {
                        const maxVal = Math.max(...vals);
                        if(state.eco === maxVal) renderFeedback('eco_master');
                        else if(state.env === maxVal) renderFeedback('env_master');
                        else renderFeedback('edu_master');
                    }
                }
            }
        }

        function renderFeedback(key) {
            const data = feedbacks[key];
            const container = document.getElementById('feedback-container');
            container.innerHTML = `
                <div class="feedback-card">
                    <div class="fb-icon">${data.icon}</div>
                    <div class="fb-content">
                        <div class="fb-name">${data.name}</div>
                        <div class="fb-text">"${data.msg}"</div>
                    </div>
                </div>
            `;
        }

        document.getElementById('start-btn').onclick = startGame;
        document.getElementById('restart-btn').onclick = resetToTitle;
        document.getElementById('bgm-toggle').onclick = toggleBGM;

        resetToTitle();
    </script>
</body>
</html>
