<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>ç”ºé•·ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 10px;
            font-family: "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        #game-container {
            width: 100%;
            max-width: 480px;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            font-size: 1.8em;
            margin: 0 0 20px 0;
            color: #333;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* ç›®çš„è¡¨ç¤º */
        #objective {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #333;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        #speak-btn {
            margin-top: 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: #ff6b6b;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #speak-btn:hover {
            background: #ee5a52;
            transform: translateY(-1px);
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        #stats-container {
            margin-bottom: 15px;
        }

        .stat-bar {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .stat-label {
            width: 60px;
            text-align: left;
            font-weight: bold;
        }

        .progress-bar {
            flex: 1;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 0 10px;
            position: relative;
            overflow: hidden;
            border: 2px solid #ccc;
        }

        .progress-fill {
            height: 100%;
            border-radius: 8px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
        }

        .stat-value {
            width: 30px;
            text-align: right;
            font-weight: bold;
            color: #333;
        }

        /* ã‚¿ãƒ¼ãƒ³è¡¨ç¤º */
        #turn-display {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
            background: linear-gradient(90deg, #ffeaa7, #fab1a0);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
        }

        /* ç”ºæ°‘ã®åå¿œ */
        #citizen-reaction {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #333;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-out;
        }

        /* è¡—ã®è¡¨ç¤º */
        #town-container {
            margin: 20px 0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            background: linear-gradient(180deg, #87CEEB, #E0F6FF);
            position: relative;
        }

        #townSvg {
            width: 100%;
            height: auto;
            display: block;
        }

        .town-level {
            transition: opacity 1s ease-in-out;
        }

        /* äººé–“ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .person {
            animation: walk 3s linear infinite;
        }

        @keyframes walk {
            0% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            100% { transform: translateX(-10px); }
        }

        .person-fast {
            animation: walkFast 2s linear infinite;
        }

        @keyframes walkFast {
            0% { transform: translateX(-15px); }
            25% { transform: translateX(15px); }
            50% { transform: translateX(-15px); }
            75% { transform: translateX(15px); }
            100% { transform: translateX(-15px); }
        }

        /* é¸æŠè‚¢ãƒœã‚¿ãƒ³ */
        .choice {
            display: block;
            margin: 12px 0;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(0);
            position: relative;
            overflow: hidden;
        }

        .choice::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .choice:hover::before,
        .choice:active::before {
            left: 100%;
        }

        .choice:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .choice:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        /* åŠ¹æœäºˆæ¸¬è¡¨ç¤º */
        .effect-preview {
            font-size: 11px;
            margin-top: 5px;
            opacity: 0.9;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .effect-item {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .effect-positive { color: #90EE90; }
        .effect-negative { color: #FFB6C1; }

        /* ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚° */
        #end {
            font-size: 1.4em;
            margin-top: 20px;
            font-weight: bold;
            padding: 20px;
            border-radius: 15px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.8s ease-out;
        }

        /* ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
        #restart-btn {
            margin-top: 20px;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        #restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            #game-container {
                padding: 15px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            .choice {
                font-size: 14px;
                padding: 12px 15px;
            }
            
            .stat-label {
                width: 50px;
                font-size: 12px;
            }
            
            .stat-value {
                width: 25px;
                font-size: 12px;
            }
            
            #turn-display {
                font-size: 14px;
                padding: 6px 12px;
            }
        }

        @media (max-width: 360px) {
            #game-container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.3em;
            }
            
            .choice {
                font-size: 13px;
                padding: 10px 12px;
                margin: 8px 0;
            }
        }

        /* iOS Safariå¯¾å¿œ */
        @supports (-webkit-touch-callout: none) {
            body {
                -webkit-overflow-scrolling: touch;
            }
            
            .choice {
                -webkit-appearance: none;
                -webkit-tap-highlight-color: transparent;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>ğŸŒ† ç”ºé•·ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>
        
        <!-- ç›®çš„è¡¨ç¤º -->
        <div id="objective">
            <div><strong>ğŸ¯ ã‚ãªãŸã®ä½¿å‘½</strong></div>
            <div>10ã‚¿ãƒ¼ãƒ³ã§ç†æƒ³ã®è¡—ã‚’ä½œã‚ã†ï¼çµŒæ¸ˆãƒ»ç’°å¢ƒãƒ»æ•™è‚²ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒãˆã¦ã€ä½æ°‘ãŒå¹¸ã›ã«æš®ã‚‰ã›ã‚‹è¡—ã¥ãã‚Šã‚’ç›®æŒ‡ã—ã¦ãã ã•ã„ã€‚</div>
            <button id="speak-btn">ğŸ”Š éŸ³å£°ã§èã</button>
        </div>
        
        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div id="stats-container">
            <div class="stat-bar">
                <span class="stat-label">ğŸ’° çµŒæ¸ˆ</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="eco-bar"></div>
                    <span class="stat-value" id="eco-value">0</span>
                </div>
            </div>
            <div class="stat-bar">
                <span class="stat-label">ğŸŒ¿ ç’°å¢ƒ</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="env-bar"></div>
                    <span class="stat-value" id="env-value">0</span>
                </div>
            </div>
            <div class="stat-bar">
                <span class="stat-label">ğŸ“š æ•™è‚²</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="edu-bar"></div>
                    <span class="stat-value" id="edu-value">0</span>
                </div>
            </div>
        </div>

        <!-- ã‚¿ãƒ¼ãƒ³è¡¨ç¤º -->
        <div id="turn-display">ã‚¿ãƒ¼ãƒ³: <span id="turn-number">1</span>/10</div>

        <!-- ç”ºæ°‘ã®åå¿œ -->
        <div id="citizen-reaction">ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</div>

        <!-- è¡—ã®è¡¨ç¤ºï¼ˆSVGï¼‰ -->
        <div id="town-container">
            <svg id="townSvg" viewBox="0 0 600 300">
                <!-- èƒŒæ™¯ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ -->
                <defs>
                    <linearGradient id="skyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#87CEEB"/>
                        <stop offset="100%" style="stop-color:#E0F6FF"/>
                    </linearGradient>
                    <linearGradient id="groundGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#90EE90"/>
                        <stop offset="100%" style="stop-color:#228B22"/>
                    </linearGradient>
                </defs>
                
                <!-- ç©ºã¨åœ°é¢ -->
                <rect width="600" height="220" fill="url(#skyGradient)" />
                <rect y="220" width="600" height="80" fill="url(#groundGradient)" />
                
                <!-- å¤ªé™½ -->
                <circle cx="50" cy="50" r="25" fill="#FFD700" opacity="0.8"/>
                
                <!-- é›² -->
                <ellipse cx="150" cy="60" rx="30" ry="15" fill="white" opacity="0.7"/>
                <ellipse cx="450" cy="80" rx="40" ry="20" fill="white" opacity="0.6"/>

                <!-- æ‘ãƒ¬ãƒ™ãƒ«ï¼ˆ1-15ãƒã‚¤ãƒ³ãƒˆï¼‰ -->
                <g id="village" class="town-level">
                    <!-- å°ã•ãªå®¶1 -->
                    <rect x="80" y="180" width="40" height="40" fill="#8B4513" stroke="#654321" stroke-width="2"/>
                    <polygon points="80,180 100,160 120,180" fill="#DC143C"/>
                    <rect x="90" y="200" width="8" height="15" fill="#4169E1"/>
                    <rect x="105" y="190" width="8" height="8" fill="#87CEEB"/>
                    
                    <!-- å°ã•ãªå®¶2 -->
                    <rect x="200" y="185" width="35" height="35" fill="#CD853F" stroke="#8B7355" stroke-width="2"/>
                    <polygon points="200,185 217.5,168 235,185" fill="#B22222"/>
                    <rect x="208" y="200" width="6" height="12" fill="#228B22"/>
                    
                    <!-- å°ã•ãªå®¶3 -->
                    <rect x="320" y="175" width="45" height="45" fill="#DEB887" stroke="#D2B48C" stroke-width="2"/>
                    <polygon points="320,175 342.5,155 365,175" fill="#A0522D"/>
                    <rect x="330" y="195" width="8" height="18" fill="#654321"/>
                    <rect x="345" y="185" width="10" height="10" fill="#F0E68C"/>
                    
                    <!-- æœ¨ -->
                    <rect x="150" y="200" width="6" height="20" fill="#8B4513"/>
                    <circle cx="153" cy="195" r="12" fill="#228B22"/>
                    <rect x="400" y="195" width="8" height="25" fill="#8B4513"/>
                    <circle cx="404" cy="190" r="15" fill="#32CD32"/>
                    
                    <!-- æ‘ã®äººã€… -->
                    <g id="village-people">
                        <circle class="person" cx="130" cy="210" r="3" fill="#FFB6C1"/>
                        <rect class="person" x="128" y="213" width="4" height="7" fill="#4169E1"/>
                        
                        <circle class="person" cx="270" cy="215" r="3" fill="#DEB887"/>
                        <rect class="person" x="268" y="218" width="4" height="7" fill="#DC143C"/>
                    </g>
                </g>

                <!-- ç”ºãƒ¬ãƒ™ãƒ«ï¼ˆ16-35ãƒã‚¤ãƒ³ãƒˆï¼‰ -->
                <g id="town" class="town-level" style="opacity: 0;">
                    <!-- ä¸­å±¤ãƒ“ãƒ«1 -->
                    <rect x="70" y="120" width="50" height="100" fill="#708090" stroke="#2F4F4F" stroke-width="2"/>
                    <rect x="75" y="130" width="8" height="8" fill="#FFD700"/>
                    <rect x="85" y="130" width="8" height="8" fill="#FFD700"/>
                    <rect x="75" y="145" width="8" height="8" fill="#FFD700"/>
                    <rect x="85" y="145" width="8" height="8" fill="#FFD700"/>
                    
                    <!-- ä¸­å±¤ãƒ“ãƒ«2 -->
                    <rect x="180" y="100" width="60" height="120" fill="#4682B4" stroke="#191970" stroke-width="2"/>
                    <rect x="190" y="110" width="10" height="10" fill="#00BFFF"/>
                    <rect x="205" y="110" width="10" height="10" fill="#00BFFF"/>
                    <rect x="190" y="130" width="10" height="10" fill="#00BFFF"/>
                    <rect x="205" y="130" width="10" height="10" fill="#00BFFF"/>
                    
                    <!-- å­¦æ ¡ -->
                    <rect x="300" y="140" width="80" height="80" fill="#FF6347" stroke="#DC143C" stroke-width="2"/>
                    <polygon points="300,140 340,110 380,140" fill="#8B0000"/>
                    <rect x="330" y="160" width="20" height="25" fill="#654321"/>
                    <text x="340" y="135" font-family="Arial" font-size="12" fill="white" text-anchor="middle">å­¦æ ¡</text>
                    
                    <!-- å…¬åœ’ -->
                    <rect x="450" y="180" width="60" height="40" fill="#90EE90" stroke="#228B22" stroke-width="2"/>
                    <circle cx="470" cy="195" r="8" fill="#32CD32"/>
                    <circle cx="490" cy="205" r="6" fill="#228B22"/>
                    
                    <!-- ç”ºã®äººã€… -->
                    <g id="town-people">
                        <circle class="person" cx="100" cy="215" r="3" fill="#FFB6C1"/>
                        <rect class="person" x="98" y="218" width="4" height="7" fill="#4169E1"/>
                        
                        <circle class="person" cx="150" cy="210" r="3" fill="#DEB887"/>
                        <rect class="person" x="148" y="213" width="4" height="7" fill="#DC143C"/>
                        
                        <circle class="person-fast" cx="250" cy="215" r="3" fill="#98FB98"/>
                        <rect class="person-fast" x="248" y="218" width="4" height="7" fill="#228B22"/>
                        
                        <circle class="person" cx="350" cy="213" r="3" fill="#F0E68C"/>
                        <rect class="person" x="348" y="216" width="4" height="7" fill="#8B4513"/>
                        
                        <circle class="person-fast" cx="480" cy="212" r="3" fill="#DDA0DD"/>
                        <rect class="person-fast" x="478" y="215" width="4" height="7" fill="#9370DB"/>
                    </g>
                </g>

                <!-- éƒ½å¸‚ãƒ¬ãƒ™ãƒ«ï¼ˆ36ãƒã‚¤ãƒ³ãƒˆä»¥ä¸Šï¼‰ -->
                <g id="city" class="town-level" style="opacity: 0;">
                    <!-- è¶…é«˜å±¤ãƒ“ãƒ«1 -->
                    <rect x="60" y="40" width="60" height="180" fill="#2F4F4F" stroke="#000000" stroke-width="3"/>
                    <rect x="70" y="50" width="12" height="12" fill="#00FFFF"/>
                    <rect x="90" y="50" width="12" height="12" fill="#00FFFF"/>
                    <rect x="70" y="70" width="12" height="12" fill="#00FFFF"/>
                    <rect x="90" y="70" width="12" height="12" fill="#00FFFF"/>
                    <rect x="70" y="90" width="12" height="12" fill="#00FFFF"/>
                    <rect x="90" y="90" width="12" height="12" fill="#00FFFF"/>
                    
                    <!-- è¶…é«˜å±¤ãƒ“ãƒ«2 -->
                    <rect x="170" y="20" width="70" height="200" fill="#1E90FF" stroke="#0000CD" stroke-width="3"/>
                    <rect x="180" y="35" width="15" height="15" fill="#FFFF00"/>
                    <rect x="200" y="35" width="15" height="15" fill="#FFFF00"/>
                    <rect x="180" y="60" width="15" height="15" fill="#FFFF00"/>
                    <rect x="200" y="60" width="15" height="15" fill="#FFFF00"/>
                    
                    <!-- ã‚¿ãƒ¯ãƒ¼ -->
                    <rect x="290" y="30" width="40" height="190" fill="#FF1493" stroke="#8B008B" stroke-width="3"/>
                    <circle cx="310" cy="25" r="8" fill="#FF0000"/>
                    <rect x="305" y="15" width="10" height="15" fill="#696969"/>
                    
                    <!-- æœªæ¥çš„ãƒ“ãƒ« -->
                    <polygon points="380,220 380,60 420,40 460,60 460,220" fill="#9370DB" stroke="#4B0082" stroke-width="3"/>
                    <rect x="390" y="80" width="20" height="20" fill="#00FF7F"/>
                    <rect x="415" y="100" width="20" height="20" fill="#00FF7F"/>
                    
                    <!-- ç©ºæ¸¯/ãƒ˜ãƒªãƒãƒ¼ãƒˆ -->
                    <rect x="500" y="180" width="80" height="40" fill="#696969" stroke="#000000" stroke-width="2"/>
                    <text x="540" y="205" font-family="Arial" font-size="14" fill="white" text-anchor="middle">H</text>
                    
                    <!-- éƒ½å¸‚ã®äººã€… -->
                    <g id="city-people">
                        <circle class="person-fast" cx="90" cy="215" r="3" fill="#FFB6C1"/>
                        <rect class="person-fast" x="88" y="218" width="4" height="7" fill="#4169E1"/>
                        
                        <circle class="person" cx="130" cy="212" r="3" fill="#DEB887"/>
                        <rect class="person" x="128" y="215" width="4" height="7" fill="#DC143C"/>
                        
                        <circle class="person-fast" cx="170" cy="214" r="3" fill="#98FB98"/>
                        <rect class="person-fast" x="168" y="217" width="4" height="7" fill="#228B22"/>
                        
                        <circle class="person" cx="220" cy="216" r="3" fill="#F0E68C"/>
                        <rect class="person" x="218" y="219" width="4" height="7" fill="#8B4513"/>
                        
                        <circle class="person-fast" cx="270" cy="213" r="3" fill="#DDA0DD"/>
                        <rect class="person-fast" x="268" y="216" width="4" height="7" fill="#9370DB"/>
                        
                        <circle class="person" cx="350" cy="215" r="3" fill="#FFA07A"/>
                        <rect class="person" x="348" y="218" width="4" height="7" fill="#FF4500"/>
                        
                        <circle class="person-fast" cx="420" cy="211" r="3" fill="#87CEEB"/>
                        <rect class="person-fast" x="418" y="214" width="4" height="7" fill="#4682B4"/>
                        
                        <circle class="person" cx="480" cy="217" r="3" fill="#F5DEB3"/>
                        <rect class="person" x="478" y="220" width="4" height="7" fill="#D2691E"/>
                        
                        <circle class="person-fast" cx="530" cy="214" r="3" fill="#FFE4E1"/>
                        <rect class="person-fast" x="528" y="217" width="4" height="7" fill="#CD5C5C"/>
                    </g>
                </g>
            </svg>
        </div>

        <!-- é¸æŠè‚¢ -->
        <div id="choices"></div>
        
        <!-- çµæœè¡¨ç¤º -->
        <div id="end"></div>
        
        <!-- ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
        <button id="restart-btn" style="display: none;">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®ç®¡ç†
        let gameState = {
            eco: 0,
            env: 0, 
            edu: 0,
            turn: 0,
            maxTurns: 10,
            audioCtx: null,
            isBgmStarted: false,
            speechSynthesis: null
        };

        // 10ã‚¿ãƒ¼ãƒ³åˆ†ã®é¸æŠè‚¢ãƒ‡ãƒ¼ã‚¿
        const choicesData = [
            [
                { text: "ğŸ­ å·¥å ´ã‚’èª˜è‡´ã™ã‚‹", eco: +4, env: -2, edu: 0, desc: "çµŒæ¸ˆã‚’å¤§ããç™ºå±•ã•ã›ã¾ã™" },
                { text: "ğŸŒ³ å…¬åœ’ã‚’æ•´å‚™ã™ã‚‹", eco: -1, env: +4, edu: 0, desc: "ç’°å¢ƒã‚’å¤§å¹…ã«æ”¹å–„ã—ã¾ã™" },
                { text: "ğŸ“– å›³æ›¸é¤¨ã‚’å»ºã¦ã‚‹", eco: -2, env: 0, edu: +4, desc: "æ•™è‚²ãƒ¬ãƒ™ãƒ«ã‚’å‘ä¸Šã•ã›ã¾ã™" }
            ],
            [
                { text: "ğŸ›£ï¸ é«˜é€Ÿé“è·¯ã‚’å»ºè¨­", eco: +5, env: -3, edu: 0, desc: "ç‰©æµãŒæ´»ç™ºã«ãªã‚Šã¾ã™" },
                { text: "ğŸ¦‹ æ£®æ—ä¿è­·åŒºã‚’è¨­ç½®", eco: -1, env: +5, edu: 0, desc: "è‡ªç„¶ç’°å¢ƒã‚’å®ˆã‚Šã¾ã™" },
                { text: "ğŸ« å¤§å­¦ã‚’èª˜è‡´ã™ã‚‹", eco: -2, env: 0, edu: +5, desc: "é«˜ç­‰æ•™è‚²ã‚’å……å®Ÿã•ã›ã¾ã™" }
            ],
            [
                { text: "ğŸŒ å›½éš›ä¼æ¥­ã‚’èª˜è‡´", eco: +6, env: -3, edu: +1, desc: "ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–ã‚’é€²ã‚ã¾ã™" },
                { text: "â™»ï¸ ãƒªã‚µã‚¤ã‚¯ãƒ«æ¡ä¾‹åˆ¶å®š", eco: -1, env: +6, edu: 0, desc: "å¾ªç’°å‹ç¤¾ä¼šã‚’ç›®æŒ‡ã—ã¾ã™" },
                { text: "ğŸ”¬ ç ”ç©¶ç‰¹åŒºã‚’è¨­ç«‹", eco: -2, env: 0, edu: +6, desc: "ç§‘å­¦æŠ€è¡“ã‚’ç™ºå±•ã•ã›ã¾ã™" }
            ],
            [
                { text: "ğŸ’° æ³•äººç¨ã‚’å¼•ãä¸‹ã’", eco: +5, env: -1, edu: 0, desc: "ä¼æ¥­æ´»å‹•ã‚’æ´»æ€§åŒ–ã—ã¾ã™" },
                { text: "âš¡ å†ç”Ÿã‚¨ãƒãƒ«ã‚®ãƒ¼æ¨é€²", eco: -2, env: +5, edu: 0, desc: "ã‚¯ãƒªãƒ¼ãƒ³ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’å°å…¥" },
                { text: "ğŸ‘¨â€ğŸ« æ•™è‚²æ”¹é©ã‚’å®Ÿæ–½", eco: -2, env: 0, edu: +5, desc: "æ•™è‚²ã‚·ã‚¹ãƒ†ãƒ ã‚’é©æ–°ã—ã¾ã™" }
            ],
            [
                { text: "ğŸ¢ ãƒ“ã‚¸ãƒã‚¹ç‰¹åŒºã‚’å‰µè¨­", eco: +6, env: -2, edu: +1, desc: "å•†æ¥­åœ°åŒºã‚’æ‹¡å¤§ã—ã¾ã™" },
                { text: "ğŸŒŠ æµ·æ´‹ä¿è­·è¨ˆç”»", eco: -2, env: +6, edu: 0, desc: "æµ·ã®ç’°å¢ƒã‚’å®ˆã‚Šã¾ã™" },
                { text: "ğŸ’» ITæ•™è‚²ã‚’å¼·åŒ–", eco: -1, env: 0, edu: +6, desc: "ãƒ‡ã‚¸ã‚¿ãƒ«äººæã‚’è‚²æˆã—ã¾ã™" }
            ],
            [
                { text: "ğŸš¢ è²¿æ˜“æ¸¯ã‚’æ•´å‚™", eco: +6, env: -3, edu: +1, desc: "å›½éš›è²¿æ˜“ã‚’æ‹¡å¤§ã—ã¾ã™" },
                { text: "ğŸŒ± éƒ½å¸‚ç·‘åŒ–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ", eco: -1, env: +6, edu: 0, desc: "ç·‘è±Šã‹ãªè¡—ã¥ãã‚Š" },
                { text: "ğŸ§ª ç§‘å­¦é¤¨ã‚’å»ºè¨­", eco: -2, env: 0, edu: +6, desc: "ç§‘å­¦æ•™è‚²ã‚’æ¨é€²ã—ã¾ã™" }
            ],
            [
                { text: "ğŸª å•†æ¥­æ–½è¨­ã‚’æ‹¡å……", eco: +7, env: -3, edu: +1, desc: "æ¶ˆè²»çµŒæ¸ˆã‚’æ´»æ€§åŒ–" },
                { text: "ğŸ¾ é‡ç”Ÿå‹•ç‰©ä¿è­·æ¡ä¾‹", eco: -2, env: +7, edu: 0, desc: "ç”Ÿç‰©å¤šæ§˜æ€§ã‚’å®ˆã‚Šã¾ã™" },
                { text: "ğŸ¨ èŠ¸è¡“å­¦æ ¡ã‚’è¨­ç«‹", eco: -1, env: 0, edu: +7, desc: "æ–‡åŒ–ãƒ»èŠ¸è¡“ã‚’æŒ¯èˆˆã—ã¾ã™" }
            ],
            [
                { text: "ğŸ¯ è¦³å…‰ç”£æ¥­ã‚’è‚²æˆ", eco: +6, env: -2, edu: +2, desc: "è¦³å…‰åå…¥ã‚’å¢—ã‚„ã—ã¾ã™" },
                { text: "ğŸŒ¿ ã‚«ãƒ¼ãƒœãƒ³ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«å®£è¨€", eco: -3, env: +7, edu: 0, desc: "è„±ç‚­ç´ ç¤¾ä¼šã‚’å®Ÿç¾" },
                { text: "ğŸŒ å›½éš›äº¤æµã‚’ä¿ƒé€²", eco: -1, env: 0, edu: +7, desc: "å›½éš›çš„ãªäººæã‚’è‚²æˆ" }
            ],
            [
                { text: "ğŸš€ å®‡å®™ç”£æ¥­ã‚’èª˜è‡´", eco: +8, env: -2, edu: +2, desc: "æœ€å…ˆç«¯æŠ€è¡“ã‚’å°å…¥" },
                { text: "ğŸŒº å®Œå…¨å¾ªç’°å‹éƒ½å¸‚è¨ˆç”»", eco: -3, env: +8, edu: 0, desc: "æŒç¶šå¯èƒ½ãªç¤¾ä¼šã‚’æ§‹ç¯‰" },
                { text: "ğŸ† ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯æ‹›è‡´", eco: -2, env: 0, edu: +8, desc: "ä¸–ç•Œãƒ¬ãƒ™ãƒ«ã®æ•™è‚²ãƒ»æ–‡åŒ–" }
            ],
            [
                { text: "ğŸ’ é‡‘èã‚»ãƒ³ã‚¿ãƒ¼è¨­ç«‹", eco: +10, env: -3, edu: +1, desc: "ä¸–ç•Œçš„ãªé‡‘èãƒãƒ–ã«" },
                { text: "ğŸŒ åœ°çƒç’°å¢ƒã‚µãƒŸãƒƒãƒˆé–‹å‚¬", eco: -3, env: +10, edu: 0, desc: "ç’°å¢ƒã®ãƒªãƒ¼ãƒ€ãƒ¼éƒ½å¸‚ã«" },
                { text: "ğŸ“ ä¸–ç•Œæœ€é«˜å­¦åºœã‚’è¨­ç«‹", eco: -2, env: 0, edu: +10, desc: "æ•™è‚²ã®ä¸–ç•Œçš„æ‹ ç‚¹ã«" }
            ]
        ];

        // ç”ºæ°‘ã®åå¿œãƒ‡ãƒ¼ã‚¿
        const citizenReactions = {
            eco: {
                positive: [
                    "ğŸ‘¨â€ğŸ’¼ å¸‚æ°‘Aã€Œä»•äº‹ãŒå¢—ãˆã¦å¬‰ã—ã„ã§ã™ï¼ã€",
                    "ğŸ‘©â€ğŸ’¼ ä¼æ¥­å®¶Bã€ŒæŠ•è³‡ã—ã‚„ã™ã„ç’°å¢ƒã§ã™ã­ã€",
                    "ğŸª å•†åº—ä¸»Cã€ŒãŠå®¢ã•ã‚“ãŒå¢—ãˆã¾ã—ãŸï¼ã€",
                    "ğŸ’¼ ã‚µãƒ©ãƒªãƒ¼ãƒãƒ³Dã€Œçµ¦æ–™ãŒä¸ŠãŒã‚Šãã†ã§ã™ã€",
                    "ğŸ¢ ä¼šç¤¾å“¡Eã€Œæ–°ã—ã„ãƒ“ã‚¸ãƒã‚¹ãƒãƒ£ãƒ³ã‚¹ãŒï¼ã€"
                ],
                negative: [
                    "ğŸ˜Ÿ å¸‚æ°‘Fã€Œç”Ÿæ´»è²»ãŒé«˜ããªã£ã¦å›°ã‚Šã¾ã™ã€",
                    "ğŸ’¸ ä¸»å©¦Gã€Œç‰©ä¾¡ä¸Šæ˜‡ãŒå¿ƒé…ã§ã™ã€",
                    "ğŸ˜° å¹´é‡‘ç”Ÿæ´»è€…Hã€Œå¹´é‡‘ã ã‘ã§ã¯å³ã—ã„ã€"
                ]
            },
            env: {
                positive: [
                    "ğŸŒ¿ ç’°å¢ƒæ´»å‹•å®¶ã€Œç´ æ™´ã‚‰ã—ã„åˆ¤æ–­ã§ã™ï¼ã€",
                    "ğŸ‘¶ è‹¥ã„ãƒãƒã€Œå­ä¾›ã«ç¶ºéº—ãªç’°å¢ƒã‚’æ®‹ã›ã¾ã™ã€",
                    "ğŸ¦ é³¥é¡ç ”ç©¶è€…ã€Œç”Ÿæ…‹ç³»ãŒè±Šã‹ã«ãªã‚Šã¾ã™ã­ã€",
                    "ğŸš´â€â™‚ï¸ ã‚µã‚¤ã‚¯ãƒªã‚¹ãƒˆã€Œç©ºæ°—ãŒç¾å‘³ã—ã„ï¼ã€",
                    "ğŸŒ± åœ’èŠ¸æ„›å¥½å®¶ã€Œç·‘ãŒå¢—ãˆã¦å¬‰ã—ã„ã§ã™ã€"
                ],
                negative: [
                    "ğŸ˜¤ å·¥å ´é•·ã€Œè¦åˆ¶ãŒå³ã—ã™ãã¾ã™ã€",
                    "ğŸš— é‹é€æ¥­è€…ã€Œã‚³ã‚¹ãƒˆãŒä¸ŠãŒã£ã¦å›°ã‚‹ã€",
                    "ğŸ˜®â€ğŸ’¨ å»ºè¨­æ¥­è€…ã€Œå·¥äº‹ãŒåˆ¶é™ã•ã‚Œã¦...ã€"
                ]
            },
            edu: {
                positive: [
                    "ğŸ‘¨â€ğŸ« æ•™å¸«ã€Œæ•™è‚²ç’°å¢ƒãŒå‘ä¸Šã—ã¾ã—ãŸï¼ã€",
                    "ğŸ‘©â€ğŸ“ å­¦ç”Ÿã€Œå‹‰å¼·ã§ãã‚‹å ´æ‰€ãŒå¢—ãˆãŸï¼ã€",
                    "ğŸ“š å¸æ›¸ã€Œå›³æ›¸é¤¨åˆ©ç”¨è€…ãŒå¢—ãˆã¦ã„ã¾ã™ã€",
                    "ğŸ§‘â€ğŸ”¬ ç ”ç©¶è€…ã€Œç ”ç©¶æ–½è¨­ãŒå……å®Ÿã—ã¾ã—ãŸã€",
                    "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ä¿è­·è€…ã€Œå­ä¾›ã®å°†æ¥ãŒæ˜ã‚‹ã„ï¼ã€"
                ],
                negative: [
                    "ğŸ’° ç´ç¨è€…ã€Œæ•™è‚²è²»ã®è² æ‹…ãŒé‡ã„ã€",
                    "ğŸ˜Ÿ é«˜é½¢è€…ã€Œè‹¥è€…ã°ã‹ã‚Šå„ªé‡ã•ã‚Œã¦...ã€",
                    "ğŸ’¼ çµŒå–¶è€…ã€Œäººæè‚²æˆã«æ™‚é–“ãŒã‹ã‹ã‚‹ã€"
                ]
            },
            balance: [
                "ğŸ¯ æ”¿æ²»è©•è«–å®¶ã€Œãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸæ”¿ç­–ã§ã™ã­ã€",
                "ğŸ“Š å¸‚æ”¿ã‚¢ãƒŠãƒªã‚¹ãƒˆã€Œä½æ°‘æº€è¶³åº¦ãŒé«˜ã„ã§ã™ã€",
                "ğŸ›ï¸ è­°å“¡Aã€Œç†æƒ³çš„ãªè¡—ã¥ãã‚Šã§ã™ã€",
                "ğŸ‘¥ å¸‚æ°‘ä»£è¡¨ã€Œã¿ã‚“ãªãŒç´å¾—ã§ãã‚‹æ”¿ç­–ã€"
            ],
            advisor: [
                "ğŸ¤µ ç§˜æ›¸å®˜ã€Œå¸‚é•·ã€ç´ æ™´ã‚‰ã—ã„åˆ¤æ–­ã§ã™ã€",
                "ğŸ‘¨â€ğŸ’¼ è²¡æ”¿èª²é•·ã€Œäºˆç®—é…åˆ†ãŒé©åˆ‡ã§ã™ã­ã€",
                "ğŸ‘©â€ğŸ’¼ ä¼ç”»éƒ¨é•·ã€Œé•·æœŸçš„ãªè¦–ç‚¹ã§è‰¯ã„ã§ã—ã‚‡ã†ã€",
                "ğŸ›ï¸ å‰¯å¸‚é•·ã€Œå¸‚æ°‘ã®æ”¯æŒç‡ãŒä¸ŠãŒã‚Šãã†ã§ã™ã€"
            ]
        };

        // éŸ³å£°èª­ã¿ä¸Šã’æ©Ÿèƒ½
        function speakObjective() {
            if ('speechSynthesis' in window) {
                const text = "ã‚ãªãŸã®ä½¿å‘½ã¯ã€10ã‚¿ãƒ¼ãƒ³ã§ç†æƒ³ã®è¡—ã‚’ä½œã‚‹ã“ã¨ã§ã™ã€‚çµŒæ¸ˆã€ç’°å¢ƒã€æ•™è‚²ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒãˆã¦ã€ä½æ°‘ãŒå¹¸ã›ã«æš®ã‚‰ã›ã‚‹è¡—ã¥ãã‚Šã‚’ç›®æŒ‡ã—ã¦ãã ã•ã„ã€‚";
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP';
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                speechSynthesis.speak(utterance);
            } else {
                alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
            }
        }

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        function initGame() {
            gameState = {
                eco: 0,
                env: 0,
                edu: 0,
                turn: 0,
                maxTurns: 10,
                audioCtx: null,
                isBgmStarted: false
            };
            
            document.getElementById("end").textContent = "";
            document.getElementById("end").style.display = "none";
            document.getElementById("restart-btn").style.display = "none";
            document.body.style.background = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
            document.getElementById("citizen-reaction").textContent = "ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„";
            
            updateDisplay();
            showChoices();
            
            // BGMé–‹å§‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¾Œï¼‰
            window.addEventListener("click", startBGM, { once: true });
            window.addEventListener("touchstart", startBGM, { once: true });
        }

        // è¡¨ç¤ºæ›´æ–°
        function updateDisplay() {
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å€¤æ›´æ–°
            document.getElementById("eco-value").textContent = gameState.eco;
            document.getElementById("env-value").textContent = gameState.env;
            document.getElementById("edu-value").textContent = gameState.edu;
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°ï¼ˆæœ€å¤§å€¤60ã§è¨ˆç®—ï¼‰
            const maxValue = 60;
            document.getElementById("eco-bar").style.width = `${Math.min((gameState.eco / maxValue) * 100, 100)}%`;
            document.getElementById("env-bar").style.width = `${Math.min((gameState.env / maxValue) * 100, 100)}%`;
            document.getElementById("edu-bar").style.width = `${Math.min((gameState.edu / maxValue) * 100, 100)}%`;
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®è‰²ã‚’å‹•çš„ã«å¤‰æ›´
            updateProgressBarColors();
            
            // ã‚¿ãƒ¼ãƒ³æ•°æ›´æ–°
            document.getElementById("turn-number").textContent = gameState.turn + 1;
            
            // è¡—ã®ç™ºå±•ãƒ¬ãƒ™ãƒ«æ›´æ–°
            updateTownLevel();
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®è‰²ã‚’æ›´æ–°
        function updateProgressBarColors() {
            const ecoBar = document.getElementById("eco-bar");
            const envBar = document.getElementById("env-bar");
            const eduBar = document.getElementById("edu-bar");
            
            // çµŒæ¸ˆãƒãƒ¼ï¼ˆé‡‘è‰²ç³»ï¼‰
            ecoBar.style.background = `linear-gradient(90deg, #FFD700, #FFA500)`;
            
            // ç’°å¢ƒãƒãƒ¼ï¼ˆç·‘è‰²ç³»ï¼‰
            envBar.style.background = `linear-gradient(90deg, #90EE90, #32CD32)`;
            
            // æ•™è‚²ãƒãƒ¼ï¼ˆé’è‰²ç³»ï¼‰
            eduBar.style.background = `linear-gradient(90deg, #87CEEB, #4169E1)`;
        }

        // è¡—ã®ç™ºå±•ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºåˆ‡æ›¿
        function updateTownLevel() {
            const total = gameState.eco + gameState.env + gameState.edu;
            
            const village = document.getElementById("village");
            const town = document.getElementById("town");
            const city = document.getElementById("city");
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§åˆ‡ã‚Šæ›¿ãˆ
            if (total < 15) {
                // æ‘ãƒ¬ãƒ™ãƒ«
                village.style.opacity = "1";
                town.style.opacity = "0";
                city.style.opacity = "0";
            } else if (total < 35) {
                // ç”ºãƒ¬ãƒ™ãƒ«
                village.style.opacity = "0";
                town.style.opacity = "1";
                city.style.opacity = "0";
                
                // ç™ºå±•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                town.style.animation = "pulse 1s ease-in-out";
                setTimeout(() => {
                    town.style.animation = "";
                }, 1000);
            } else {
                // éƒ½å¸‚ãƒ¬ãƒ™ãƒ«
                village.style.opacity = "0";
                town.style.opacity = "0";
                city.style.opacity = "1";
                
                // ç™ºå±•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                city.style.animation = "pulse 1.5s ease-in-out";
                setTimeout(() => {
                    city.style.animation = "";
                }, 1500);
            }
        }

        // ç”ºæ°‘ã®åå¿œã‚’è¡¨ç¤º
        function showCitizenReaction(choice) {
            const reactionDiv = document.getElementById("citizen-reaction");
            let reaction = "";
            
            // é¸æŠã®å½±éŸ¿ã«åŸºã¥ã„ã¦åå¿œã‚’æ±ºå®š
            if (Math.abs(choice.eco) >= Math.abs(choice.env) && Math.abs(choice.eco) >= Math.abs(choice.edu)) {
                // çµŒæ¸ˆã«æœ€ã‚‚å½±éŸ¿
                if (choice.eco > 0) {
                    reaction = citizenReactions.eco.positive[Math.floor(Math.random() * citizenReactions.eco.positive.length)];
                } else {
                    reaction = citizenReactions.eco.negative[Math.floor(Math.random() * citizenReactions.eco.negative.length)];
                }
            } else if (Math.abs(choice.env) >= Math.abs(choice.eco) && Math.abs(choice.env) >= Math.abs(choice.edu)) {
                // ç’°å¢ƒã«æœ€ã‚‚å½±éŸ¿
                if (choice.env > 0) {
                    reaction = citizenReactions.env.positive[Math.floor(Math.random() * citizenReactions.env.positive.length)];
                } else {
                    reaction = citizenReactions.env.negative[Math.floor(Math.random() * citizenReactions.env.negative.length)];
                }
            } else if (choice.edu !== 0) {
                // æ•™è‚²ã«å½±éŸ¿
                if (choice.edu > 0) {
                    reaction = citizenReactions.edu.positive[Math.floor(Math.random() * citizenReactions.edu.positive.length)];
                } else {
                    reaction = citizenReactions.edu.negative[Math.floor(Math.random() * citizenReactions.edu.negative.length)];
                }
            } else {
                // ãƒãƒ©ãƒ³ã‚¹å‹ã¾ãŸã¯ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼
                const reactionType = Math.random() < 0.5 ? 'balance' : 'advisor';
                reaction = citizenReactions[reactionType][Math.floor(Math.random() * citizenReactions[reactionType].length)];
            }
            
            reactionDiv.textContent = reaction;
            reactionDiv.style.animation = "none";
            setTimeout(() => {
                reactionDiv.style.animation = "fadeIn 0.5s ease-out";
            }, 10);
        }

        // é¸æŠè‚¢è¡¨ç¤º
        function showChoices() {
            const container = document.getElementById("choices");
            container.innerHTML = "";
            
            if (gameState.turn >= gameState.maxTurns) {
                endGame();
                return;
            }
            
            const currentChoices = choicesData[gameState.turn];
            
            currentChoices.forEach((choice, index) => {
                const btn = document.createElement("button");
                btn.className = "choice";
                
                // åŠ¹æœäºˆæ¸¬ã‚’ä½œæˆ
                const effects = [];
                if (choice.eco !== 0) {
                    effects.push(`<span class="effect-item ${choice.eco > 0 ? 'effect-positive' : 'effect-negative'}">ğŸ’°${choice.eco > 0 ? '+' : ''}${choice.eco}</span>`);
                }
                if (choice.env !== 0) {
                    effects.push(`<span class="effect-item ${choice.env > 0 ? 'effect-positive' : 'effect-negative'}">ğŸŒ¿${choice.env > 0 ? '+' : ''}${choice.env}</span>`);
                }
                if (choice.edu !== 0) {
                    effects.push(`<span class="effect-item ${choice.edu > 0 ? 'effect-positive' : 'effect-negative'}">ğŸ“š${choice.edu > 0 ? '+' : ''}${choice.edu}</span>`);
                }
                
                btn.innerHTML = `
                    <div style="font-size: 16px; margin-bottom: 5px;">${choice.text}</div>
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">${choice.desc}</div>
                    <div class="effect-preview">${effects.join('')}</div>
                `;
                
                btn.onclick = () => makeChoice(choice);
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§è¡¨ç¤º
                btn.style.opacity = "0";
                btn.style.transform = "translateY(20px)";
                container.appendChild(btn);
                
                setTimeout(() => {
                    btn.style.transition = "all 0.5s cubic-bezier(0.4, 0, 0.2, 1)";
                    btn.style.opacity = "1";
                    btn.style.transform = "translateY(0)";
                }, index * 100);
            });
        }

        // é¸æŠè‚¢ã‚’é¸ã‚“ã æ™‚ã®å‡¦ç†
        function makeChoice(choice) {
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            gameState.eco = Math.max(0, gameState.eco + choice.eco);
            gameState.env = Math.max(0, gameState.env + choice.env);
            gameState.edu = Math.max(0, gameState.edu + choice.edu);
            gameState.turn++;
            
            // åŠ¹æœéŸ³å†ç”Ÿ
            playSelectSound();
            
            // ç”ºæ°‘ã®åå¿œã‚’è¡¨ç¤º
            showCitizenReaction(choice);
            
            // é¸æŠãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const choices = document.querySelectorAll(".choice");
            choices.forEach(btn => {
                btn.style.pointerEvents = "none";
                btn.style.opacity = "0.6";
            });
            
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸
            setTimeout(() => {
                updateDisplay();
                showChoices();
            }, 1500);
        }

        // ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†
        function endGame() {
            document.getElementById("choices").innerHTML = "";
            
            const endDiv = document.getElementById("end");
            const restartBtn = document.getElementById("restart-btn");
            
            let endingText = "";
            let backgroundGradient = "";
            
            // æœ€ã‚‚é«˜ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§çµæœ«ã‚’æ±ºå®š
            if (gameState.eco > gameState.env && gameState.eco > gameState.edu) {
                endingText = "ğŸ™ï¸ çµŒæ¸ˆå¤§å›½ã¨ã—ã¦ä¸–ç•Œã«åã‚’è½Ÿã‹ã›ã¾ã—ãŸï¼\nå·¨å¤§ãªå•†æ¥­éƒ½å¸‚ãŒèª•ç”Ÿã—ã€å¤šãã®ä¼æ¥­ãŒé›†ã¾ã‚‹çµŒæ¸ˆã®ä¸­å¿ƒåœ°ã¨ãªã‚Šã¾ã—ãŸã€‚";
                backgroundGradient = "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)";
                document.getElementById("citizen-reaction").textContent = "ğŸ’¼ å¸‚æ°‘ã€ŒçµŒæ¸ˆç™ºå±•ã§ç”Ÿæ´»ãŒè±Šã‹ã«ãªã‚Šã¾ã—ãŸï¼ã€";
            } else if (gameState.env > gameState.eco && gameState.env > gameState.edu) {
                endingText = "ğŸŒ¿ ç’°å¢ƒå…ˆé€²éƒ½å¸‚ã¨ã—ã¦æœªæ¥ã®ãƒ¢ãƒ‡ãƒ«ã¨ãªã‚Šã¾ã—ãŸï¼\nç·‘è±Šã‹ã§æŒç¶šå¯èƒ½ãªç¤¾ä¼šã‚’å®Ÿç¾ã—ã€ä¸–ç•Œä¸­ã‹ã‚‰æ³¨ç›®ã•ã‚Œã‚‹ç’°å¢ƒéƒ½å¸‚ã«ãªã‚Šã¾ã—ãŸã€‚";
                backgroundGradient = "linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)";
                document.getElementById("citizen-reaction").textContent = "ğŸŒ± å¸‚æ°‘ã€Œç¶ºéº—ãªç©ºæ°—ã¨è‡ªç„¶ã«å›²ã¾ã‚Œã¦å¹¸ã›ã§ã™ï¼ã€";
            } else if (gameState.edu > gameState.eco && gameState.edu > gameState.env) {
                endingText = "ğŸ“š æ•™è‚²ç«‹å›½ã¨ã—ã¦ä¸–ç•Œæœ€é«˜ã®å­¦è¡“éƒ½å¸‚ãŒå®Œæˆã—ã¾ã—ãŸï¼\nå„ªç§€ãªäººæã‚’è¼©å‡ºã—ç¶šã‘ã€çŸ¥è­˜ã¨æ–‡åŒ–ã®ä¸–ç•Œçš„ãªæ‹ ç‚¹ã¨ãªã‚Šã¾ã—ãŸã€‚";
                backgroundGradient = "linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)";
                document.getElementById("citizen-reaction").textContent = "ğŸ“ å¸‚æ°‘ã€Œå­ä¾›ãŸã¡ã«æœ€é«˜ã®æ•™è‚²ã‚’ä¸ãˆã‚‰ã‚Œã¾ã—ãŸï¼ã€";
            } else {
                // ãƒãƒ©ãƒ³ã‚¹å‹
                endingText = "âš–ï¸ ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸç†æƒ³çš„ãªéƒ½å¸‚ãŒå®Œæˆã—ã¾ã—ãŸï¼\nçµŒæ¸ˆãƒ»ç’°å¢ƒãƒ»æ•™è‚²ã™ã¹ã¦ãŒèª¿å’Œã—ãŸã€ä½ã¿ã‚„ã™ã„è¡—ã«ãªã‚Šã¾ã—ãŸã€‚";
                backgroundGradient = "linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)";
                document.getElementById("citizen-reaction").textContent = "ğŸ˜Š å¸‚æ°‘ã€Œã™ã¹ã¦ãŒãƒãƒ©ãƒ³ã‚¹è‰¯ãã¦ä½ã¿ã‚„ã™ã„è¡—ã§ã™ï¼ã€";
            }
            
            // ç·åˆè©•ä¾¡
            const totalScore = gameState.eco + gameState.env + gameState.edu;
            let rank = "";
            if (totalScore >= 50) {
                rank = "Sç´šéƒ½å¸‚ï¼ğŸ†";
            } else if (totalScore >= 40) {
                rank = "Aç´šéƒ½å¸‚ï¼ğŸ¥‡";
            } else if (totalScore >= 30) {
                rank = "Bç´šéƒ½å¸‚ï¼ğŸ¥ˆ";
            } else if (totalScore >= 20) {
                rank = "Cç´šéƒ½å¸‚ï¼ğŸ¥‰";
            } else {
                rank = "ç™ºå±•é€”ä¸Šã®è¡—ğŸŒ±";
            }
            
            endDiv.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 1.2em;">${rank}</div>
                <div style="margin-bottom: 15px;">${endingText}</div>
                <div style="font-size: 14px; margin-top: 10px;">
                    æœ€çµ‚ã‚¹ã‚³ã‚¢: ${totalScore}ç‚¹<br>
                    ğŸ’°çµŒæ¸ˆ: ${gameState.eco} | ğŸŒ¿ç’°å¢ƒ: ${gameState.env} | ğŸ“šæ•™è‚²: ${gameState.edu}
                </div>
            `;
            
            endDiv.style.display = "block";
            restartBtn.style.display = "inline-block";
            
            // èƒŒæ™¯è‰²å¤‰æ›´
            document.body.style.background = backgroundGradient;
            
            // çµ‚äº†éŸ³åŠ¹æœ
            playEndSound();
        }

        // BGMé–‹å§‹
        function startBGM() {
            if (gameState.isBgmStarted) return;
            gameState.isBgmStarted = true;
            
            try {
                gameState.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                playBackgroundMusic();
            } catch (e) {
                console.log("Audio context not supported");
            }
        }

        // èƒŒæ™¯éŸ³æ¥½ï¼ˆã‚¢ãƒ«ãƒšã‚¸ã‚ªï¼‰
        function playBackgroundMusic() {
            if (!gameState.audioCtx) return;
            
            const chords = [
                [261.63, 329.63, 392.00], // C major
                [220.00, 277.18, 329.63], // A minor
                [246.94, 311.13, 369.99], // B diminished
                [196.00, 246.94, 293.66], // G major
            ];
            
            let chordIndex = 0;
            let startTime = gameState.audioCtx.currentTime;
            
            function scheduleChord(time, frequencies) {
                frequencies.forEach((freq, i) => {
                    const osc = gameState.audioCtx.createOscillator();
                    const gain = gameState.audioCtx.createGain();
                    
                    osc.type = "sine";
                    osc.frequency.value = freq;
                    
                    gain.gain.setValueAtTime(0, time);
                    gain.gain.linearRampToValueAtTime(0.05, time + 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.001, time + 1.5);
                    
                    osc.connect(gain).connect(gameState.audioCtx.destination);
                    osc.start(time + i * 0.15);
                    osc.stop(time + i * 0.15 + 1.5);
                });
            }
            
            function loop() {
                if (gameState.audioCtx && gameState.audioCtx.state === 'running') {
                    scheduleChord(startTime, chords[chordIndex]);
                    chordIndex = (chordIndex + 1) % chords.length;
                    startTime += 3.0;
                    setTimeout(loop, 3000);
                }
            }
            
            loop();
        }

        // é¸æŠéŸ³åŠ¹æœ
        function playSelectSound() {
            if (!gameState.audioCtx) return;
            
            try {
                const osc = gameState.audioCtx.createOscillator();
                const gain = gameState.audioCtx.createGain();
                
                osc.type = "sine";
                osc.frequency.setValueAtTime(523.25, gameState.audioCtx.currentTime); // C5
                osc.frequency.exponentialRampToValueAtTime(659.25, gameState.audioCtx.currentTime + 0.1); // E5
                
                gain.gain.setValueAtTime(0.2, gameState.audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, gameState.audioCtx.currentTime + 0.3);
                
                osc.connect(gain).connect(gameState.audioCtx.destination);
                osc.start();
                osc.stop(gameState.audioCtx.currentTime + 0.3);
            } catch (e) {
                console.log("Sound effect failed");
            }
        }

        // çµ‚äº†éŸ³åŠ¹æœ
        function playEndSound() {
            if (!gameState.audioCtx) return;
            
            try {
                const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                
                notes.forEach((freq, i) => {
                    setTimeout(() => {
                        const osc = gameState.audioCtx.createOscillator();
                        const gain = gameState.audioCtx.createGain();
                        
                        osc.type = "sine";
                        osc.frequency.value = freq;
                        
                        gain.gain.setValueAtTime(0.15, gameState.audioCtx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.001, gameState.audioCtx.currentTime + 0.8);
                        
                        osc.connect(gain).connect(gameState.audioCtx.destination);
                        osc.start();
                        osc.stop(gameState.audioCtx.currentTime + 0.8);
                    }, i * 200);
                });
            } catch (e) {
                console.log("End sound effect failed");
            }
        }

        // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆæ©Ÿèƒ½
        function restartGame() {
            initGame();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.addEventListener("DOMContentLoaded", function() {
            initGame();
            
            // éŸ³å£°èª­ã¿ä¸Šã’ãƒœã‚¿ãƒ³
            document.getElementById("speak-btn").addEventListener("click", speakObjective);
            
            // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById("restart-btn").addEventListener("click", restartGame);
            
            // iOS Safariå¯¾å¿œï¼šãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ é˜²æ­¢
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ï¼ˆã‚²ãƒ¼ãƒ ç”»é¢å›ºå®šï¼‰
            document.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç„¡åŠ¹åŒ–
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            });
        });

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã®å¯¾å¿œ
        window.addEventListener('resize', function() {
            // 100vhå¯¾ç­–ï¼ˆãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å•é¡Œï¼‰
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        });

        // åˆæœŸåŒ–æ™‚ã®ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆé«˜ã•è¨­å®š
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    </script>
</body>
</html>